<!doctype html>
<html lang="en">
<head>
<title>Lab book Fluotracify</title>
<!-- 2020-05-07 Do 18:20 -->
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="generator" content="Org-mode">
<meta name="author" content="Alexander Seltmann">

<link  href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.5/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.5/js/bootstrap.min.js"></script>
<style type="text/css">
/* org mode styles on top of twbs */

html {
    position: relative;
    min-height: 100%;
}

body {
    font-size: 18px;
    margin-bottom: 105px;
}

footer {
    position: absolute;
    bottom: 0;
    width: 100%;
    height: 101px;
    background-color: #f5f5f5;
}

footer > div {
    padding: 10px;
}

footer p {
    margin: 0 0 5px;
    text-align: center;
    font-size: 16px;
}

#table-of-contents {
    margin-top: 20px;
    margin-bottom: 20px;
}

blockquote p {
    font-size: 18px;
}

pre {
    font-size: 16px;
}

.footpara {
    display: inline-block;
}

figcaption {
  font-size: 16px;
  color: #666;
  font-style: italic;
  padding-bottom: 15px;
}

/* from twbs docs */

.bs-docs-sidebar.affix {
    position: static;
}
@media (min-width: 768px) {
    .bs-docs-sidebar {
        padding-left: 20px;
    }
}

/* All levels of nav */
.bs-docs-sidebar .nav > li > a {
    display: block;
    padding: 4px 20px;
    font-size: 14px;
    font-weight: 500;
    color: #999;
}
.bs-docs-sidebar .nav > li > a:hover,
.bs-docs-sidebar .nav > li > a:focus {
    padding-left: 19px;
    color: #A1283B;
    text-decoration: none;
    background-color: transparent;
    border-left: 1px solid #A1283B;
}
.bs-docs-sidebar .nav > .active > a,
.bs-docs-sidebar .nav > .active:hover > a,
.bs-docs-sidebar .nav > .active:focus > a {
    padding-left: 18px;
    font-weight: bold;
    color: #A1283B;
    background-color: transparent;
    border-left: 2px solid #A1283B;
}

/* Nav: second level (shown on .active) */
.bs-docs-sidebar .nav .nav {
    display: none; /* Hide by default, but at >768px, show it */
    padding-bottom: 10px;
}
.bs-docs-sidebar .nav .nav > li > a {
    padding-top: 1px;
    padding-bottom: 1px;
    padding-left: 30px;
    font-size: 12px;
    font-weight: normal;
}
.bs-docs-sidebar .nav .nav > li > a:hover,
.bs-docs-sidebar .nav .nav > li > a:focus {
    padding-left: 29px;
}
.bs-docs-sidebar .nav .nav > .active > a,
.bs-docs-sidebar .nav .nav > .active:hover > a,
.bs-docs-sidebar .nav .nav > .active:focus > a {
    padding-left: 28px;
    font-weight: 500;
}

/* Nav: third level (shown on .active) */
.bs-docs-sidebar .nav .nav .nav {
    padding-bottom: 10px;
}
.bs-docs-sidebar .nav .nav .nav > li > a {
    padding-top: 1px;
    padding-bottom: 1px;
    padding-left: 40px;
    font-size: 12px;
    font-weight: normal;
}
.bs-docs-sidebar .nav .nav .nav > li > a:hover,
.bs-docs-sidebar .nav .nav .nav > li > a:focus {
    padding-left: 39px;
}
.bs-docs-sidebar .nav .nav .nav > .active > a,
.bs-docs-sidebar .nav .nav .nav > .active:hover > a,
.bs-docs-sidebar .nav .nav .nav > .active:focus > a {
    padding-left: 38px;
    font-weight: 500;
}

/* Show and affix the side nav when space allows it */
@media (min-width: 992px) {
    .bs-docs-sidebar .nav > .active > ul {
        display: block;
    }
    /* Widen the fixed sidebar */
    .bs-docs-sidebar.affix,
    .bs-docs-sidebar.affix-bottom {
        width: 213px;
    }
    .bs-docs-sidebar.affix {
        position: fixed; /* Undo the static from mobile first approach */
        top: 20px;
    }
    .bs-docs-sidebar.affix-bottom {
        position: absolute; /* Undo the static from mobile first approach */
    }
    .bs-docs-sidebar.affix .bs-docs-sidenav,.bs-docs-sidebar.affix-bottom .bs-docs-sidenav {
        margin-top: 0;
        margin-bottom: 0
    }
}
@media (min-width: 1200px) {
    /* Widen the fixed sidebar again */
    .bs-docs-sidebar.affix-bottom,
    .bs-docs-sidebar.affix {
        width: 263px;
    }
}
</style>
<script type="text/javascript">
$(function() {
    'use strict';

    $('.bs-docs-sidebar li').first().addClass('active');

    $(document.body).scrollspy({target: '.bs-docs-sidebar'});

    $('.bs-docs-sidebar').affix();
});
</script>

<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  displayAlign: "center",
  displayIndent: "2em",
  messageStyle: "none",
  "HTML-CSS": {
    scale: 100,
    styles: {
      ".MathJax_Display": {
        "font-size": "100%"
      }
    }
  },
  "SVG": {
    scale: 100,
    styles: {
      ".MathJax_SVG_Display": {
        "font-size": "100%",
        "margin-left": "-2.281em"
      }
    }
  }
});
</script>
<script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_SVG"></script>
</head>
<body>
<div id="content" class="container">
<div class="row"><div class="col-md-9"><h1 class="title">Lab book Fluotracify</h1>

<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1"><span class="section-number-2">1</span> README</h2>
<div class="outline-text-2" id="text-1">
</div><div id="outline-container-sec-1-1" class="outline-3">
<h3 id="sec-1-1"><span class="section-number-3">1.1</span> General:</h3>
<div class="outline-text-3" id="text-1-1">
<ul class="org-ul">
<li>This file corresponds to my lab book for my doctoral thesis tackling
artifact correction in Fluorescence Correlation Spectroscopy (FCS)
measurements using Deep Neural Networks
</li>
<li>It contains explanations of how things are organized, of the workflow for
doing experiments, changes made to the code, and the observed behavior in
the "* Data" section.
</li>
<li>The branching model used is described in <a href="http://starpu-simgrid.gforge.inria.fr/misc/SIGOPS_paper.pdf">this paper</a>. Following this, if you
are interested in the "* Data" section, you have to <code>git clone</code> the <i>data</i>
branch. The <i>master</i> branch is clean from any results, it contains only
source code and the analysis.
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-1-2" class="outline-3">
<h3 id="sec-1-2"><span class="section-number-3">1.2</span> Experiments workflow:</h3>
<div class="outline-text-3" id="text-1-2">
<ol class="org-ol">
<li>Create a new branch
</li>
<li>Make sure everything is commited
</li>
<li>&#x2026;
</li>
<li>Do the analysis
</li>
<li>Add to this file into "* Data" section the entry for the results, using
the template described below
</li>
<li>Commit/push the results of this separate branch
</li>
<li>Merge this new branch with the remote "data" branch
</li>
</ol>
</div>
</div>
<div id="outline-container-sec-1-3" class="outline-3">
<h3 id="sec-1-3"><span class="section-number-3">1.3</span> Example for experimental setup procedure</h3>
<div class="outline-text-3" id="text-1-3">
</div><div id="outline-container-sec-tmux-setup" class="outline-4">
<h4 id="sec-tmux-setup"><a id="sec-1-3-1" name="sec-1-3-1"></a><span class="section-number-4">1.3.1</span> Setting up a tmux connection from using <code>ob-tmux</code> in <code>org-babel</code></h4>
<div class="outline-text-4" id="text-sec-tmux-setup">
<ul class="org-ul">
<li>prerequisite: tmux versions need to be the same locally and on the server.
Let's verify that now.
<ul class="org-ul">
<li>the local tmux version:

<div class="org-src-container">

<pre class="src src-sh">tmux -V
</pre>
</div>

<pre class="example">
tmux 3.0a
</pre>
</li>

<li>the remote tmux version:

<div class="org-src-container">

<pre class="src src-sh">ssh ara tmux -V
</pre>
</div>

<table class="table table-striped table-bordered table-hover table-condensed">


<colgroup>
<col  class="left">

<col  class="left">
</colgroup>
<tbody>
<tr>
<td class="text-left">ye53nis@ara-login01.rz.uni-jena.de's</td>
<td class="text-left">password:</td>
</tr>

<tr>
<td class="text-left">tmux</td>
<td class="text-left">3.0a</td>
</tr>
</tbody>
</table>
</li>
</ul>
</li>

<li>as is described in <a href="https://github.com/ahendriksen/ob-tmux">the ob-tmux readme</a>, the following code snippet creates
a socket on the remote machine and forwards this socket to the local
machine (note that <code>socket_path</code> was introduced in tmux version 2.2)

<div class="org-src-container">

<pre class="src src-sh"><span style="color: #268bd2;">REMOTE_SOCKET</span>=$(<span style="color: #6c71c4; font-weight: bold;">ssh</span> ara <span style="color: #2aa198;">'tmux ls -F "#{socket_path}"'</span> | head -1)
<span style="color: #839496; font-weight: bold;">echo</span> $<span style="color: #268bd2;">REMOTE_SOCKET</span>
ssh ara -tfN <span style="color: #b58900; font-weight: bold;">\</span>
    -L ~/.tmux-local-socket-remote-machine:$<span style="color: #268bd2;">REMOTE_SOCKET</span>
</pre>
</div>

<table class="table table-striped table-bordered table-hover table-condensed">


<colgroup>
<col  class="left">

<col  class="left">

<col  class="left">
</colgroup>
<tbody>
<tr>
<td class="text-left">ye53nis@ara-login01.rz.uni-jena.de's</td>
<td class="text-left">password:</td>
<td class="text-left">&#xa0;</td>
</tr>

<tr>
<td class="text-left">/tmp/tmux-67339/default</td>
<td class="text-left">&#xa0;</td>
<td class="text-left">&#xa0;</td>
</tr>

<tr>
<td class="text-left">&gt;</td>
<td class="text-left">ye53nis@ara-login01.rz.uni-jena.de's</td>
<td class="text-left">password:</td>
</tr>
</tbody>
</table>
</li>

<li>now a new tmux session with name <code>ob-NAME</code> is created when using a code
block which looks like this: <code>#+BEGIN_SRC tmux :socket
      ~/.tmux-local-socket-remote-machine :session NAME</code>
</li>
<li>Commands can be sent now to the remote tmux session, BUT note that the
output is not printed yet
</li>
<li>there is a workaround for getting output back to our LabBook.org: A <a href="#scripts-tmux">script</a>
which allows to print the output from the tmux session in an
<code>#+begin_example</code>-Block below the tmux block by pressing <code>C-c C-o</code> or <code>C-c
      C-v C-o</code> when the pointer is inside the tmux block.
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-jupyter-setup" class="outline-4">
<h4 id="sec-jupyter-setup"><a id="sec-1-3-2" name="sec-1-3-2"></a><span class="section-number-4">1.3.2</span> Setting starting a jupyter kernel from a remote jupyter session using <code>emacs-jupyter</code> in <code>org babel</code></h4>
<div class="outline-text-4" id="text-sec-jupyter-setup">
<ol class="org-ol">
<li><code>M-x jupyter-server-list-kernels</code>
<ol class="org-ol">
<li>set server URL, e.g. <code>http://localhost:8889</code>
</li>
<li>set websocket URL, e.g. <code>http://localhost:8889</code>
</li>
</ol>
</li>
<li>two possibilities
<ol class="org-ol">
<li>kernel already exists \(\to\) list of kernels and <code>kernel-ID</code> is displayed
</li>
<li>kernel does not exist \(\to\) prompt asks if you want to start one \(\to\)
<b>yes</b> \(\to\) type kernel you want to start, e.g. <code>Python 3</code>
</li>
</ol>
</li>
<li>In subtree where you want to use <code>jupyter-python</code> blocks with <code>org
       babel</code>
<ol class="org-ol">
<li>set the <code>:header-args:jupyter-python :session
          /jpy:localhost#kernel:8889-ID</code>
</li>
<li>We can customize the output folder using the following variable:
<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #859900; font-weight: bold;">setq</span> org-babel-jupyter-resource-directory <span style="color: #2aa198;">"./data/exp-test/figures-jupyter"</span>)
</pre>
</div>

<pre class="example">
./data/exp-test/figures-jupyter
</pre>
</li>
</ol>
</li>
</ol>
</div>
</div>
</div>

<div id="outline-container-sec-1-4" class="outline-3">
<h3 id="sec-1-4"><span class="section-number-3">1.4</span> tools used (notes)</h3>
<div class="outline-text-3" id="text-1-4">
</div><div id="outline-container-sec-1-4-1" class="outline-4">
<h4 id="sec-1-4-1"><span class="section-number-4">1.4.1</span> Emacs <code>magit</code></h4>
<div class="outline-text-4" id="text-1-4-1">
<ul class="org-ul">
<li><code>gitflow-avh</code> (<code>magit-flow</code>) to follow the flow
</li>
<li>possibly <a href="https://github.com/magit/magit-annex">https://github.com/magit/magit-annex</a> for large files. Follow this:
<a href="https://git-annex.branchable.com/walkthrough/">https://git-annex.branchable.com/walkthrough/</a>
</li>
<li>maybe check out git-toolbelt at some point
<a href="https://github.com/nvie/git-toolbelt#readme">https://github.com/nvie/git-toolbelt#readme</a> with
<a href="https://nvie.com/posts/git-power-tools/">https://nvie.com/posts/git-power-tools/</a>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-1-4-2" class="outline-4">
<h4 id="sec-1-4-2"><span class="section-number-4">1.4.2</span> jupyter</h4>
<div class="outline-text-4" id="text-1-4-2">
<ul class="org-ul">
<li>emacs jupyter for running and connecting to kernel on server:
<a href="https://github.com/dzop/emacs-jupyter">https://github.com/dzop/emacs-jupyter</a>
</li>
<li>if I actually still would use .ipynb files, these might come handy:
<ul class="org-ul">
<li>jupytext: <a href="https://github.com/mwouts/jupytext">https://github.com/mwouts/jupytext</a>
</li>
<li>nbstripout: <a href="https://github.com/kynan/nbstripout">https://github.com/kynan/nbstripout</a>
</li>
</ul>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-1-4-3" class="outline-4">
<h4 id="sec-1-4-3"><span class="section-number-4">1.4.3</span> mlflow</h4>
<div class="outline-text-4" id="text-1-4-3">
<ul class="org-ul">
<li><a href="https://docs.faculty.ai/user-guide/experiments/index.html">https://docs.faculty.ai/user-guide/experiments/index.html</a> and
<a href="https://docs.microsoft.com/en-us/azure/databricks/_static/notebooks/hls-image-processing/02-image-segmentation-dl.html">https://docs.microsoft.com/en-us/azure/databricks/_static/notebooks/hls-image-processing/02-image-segmentation-dl.html</a>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-1-4-4" class="outline-4">
<h4 id="sec-1-4-4"><span class="section-number-4">1.4.4</span> tensorflow</h4>
<div class="outline-text-4" id="text-1-4-4">
<ul class="org-ul">
<li><a href="https://www.tensorflow.org/tensorboard/image_summaries">https://www.tensorflow.org/tensorboard/image_summaries</a>
</li>
</ul>
</div>
</div>
</div>

<div id="outline-container-sec-1-5" class="outline-3">
<h3 id="sec-1-5"><span class="section-number-3">1.5</span> Example for &#x2026;</h3>
</div>
</div>
<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2"><span class="section-number-2">2</span> Template for data entry:</h2>
<div class="outline-text-2" id="text-2">
</div><div id="outline-container-sec-2-1" class="outline-3">
<h3 id="sec-2-1"><span class="section-number-3">2.1</span> exp-#date-#title</h3>
<div class="outline-text-3" id="text-2-1">
</div><div id="outline-container-sec-2-1-1" class="outline-4">
<h4 id="sec-2-1-1"><span class="section-number-4">2.1.1</span> git:</h4>
<div class="outline-text-4" id="text-2-1-1">
<div class="org-src-container">

<pre class="src src-sh">git log -1
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-2-1-2" class="outline-4">
<h4 id="sec-2-1-2"><span class="section-number-4">2.1.2</span> System Metadata:</h4>
<div class="outline-text-4" id="text-2-1-2">
<div class="org-src-container">

<pre class="src src-jupyter-python" id="jupyter-python-metadata"><span style="color: #859900; font-weight: bold;">import</span> os

<span style="color: #839496; background-color: #002b36;">ramlist</span> = os.popen(<span style="color: #2aa198;">'free -th'</span>).readlines()[-<span style="color: #839496; background-color: #002b36;">1</span>].split()[<span style="color: #839496; background-color: #002b36;">1</span>:]

print(<span style="color: #2aa198;">'No of CPUs in system:'</span>, os.cpu_count())
print(<span style="color: #2aa198;">'No of CPUs the current process can use:'</span>,
<span style="background-color: #073642;"> </span>   <span style="background-color: #073642;"> </span> <span style="color: #839496; font-weight: bold;">len</span>(os.sched_getaffinity(<span style="color: #839496; background-color: #002b36;">0</span>)))
print(<span style="color: #2aa198;">'load average:'</span>, os.getloadavg())
print(os.uname())
print(<span style="color: #2aa198;">'PID of process:'</span>, os.getpid())
print(<span style="color: #2aa198;">'RAM total: {}, RAM used: {}, RAM free: {}'</span>.format(
<span style="background-color: #073642;"> </span>   ramlist[<span style="color: #839496; background-color: #002b36;">0</span>], ramlist[<span style="color: #839496; background-color: #002b36;">1</span>], ramlist[<span style="color: #839496; background-color: #002b36;">2</span>]))

!echo the current directory: $PWD
!echo My disk usage:
!df -h
<span style="color: #859900; font-weight: bold;">if</span> conda_list:
<span style="background-color: #073642;"> </span>   !conda <span style="color: #839496; font-weight: bold;">list</span>
</pre>
</div>
</div>

<ol class="org-ol"><li><a id="sec-2-1-2-1" name="sec-2-1-2-1"></a><span class="label label-primary TODO">TODO</span> Add <code>os.environ</code><br ></li></ol>
</div>
<div id="outline-container-scripts-tmux" class="outline-4">
<h4 id="scripts-tmux"><a id="sec-2-1-3" name="sec-2-1-3"></a><span class="section-number-4">2.1.3</span> Tmux setup and scripts</h4>
<div class="outline-text-4" id="text-scripts-tmux">
<div class="org-src-container">

<pre class="src src-sh" id="setup-tmux">rm ~/.tmux-local-socket-remote-machine
<span style="color: #268bd2;">REMOTE_SOCKET</span>=$(<span style="color: #6c71c4; font-weight: bold;">ssh</span> ara <span style="color: #2aa198;">'tmux ls -F "#{socket_path}"'</span> | head -1)
<span style="color: #839496; font-weight: bold;">echo</span> $<span style="color: #268bd2;">REMOTE_SOCKET</span>
ssh ara -tfN <span style="color: #b58900; font-weight: bold;">\</span>
    -L ~/.tmux-local-socket-remote-machine:$<span style="color: #268bd2;">REMOTE_SOCKET</span>
</pre>
</div>

<table class="table table-striped table-bordered table-hover table-condensed">


<colgroup>
<col  class="left">

<col  class="left">

<col  class="left">

<col  class="left">

<col  class="left">

<col  class="left">

<col  class="left">

<col  class="left">

<col  class="left">
</colgroup>
<tbody>
<tr>
<td class="text-left">rm:</td>
<td class="text-left">cannot</td>
<td class="text-left">remove</td>
<td class="text-left">'<i>home/lex</i>.tmux-local-socket-remote-machine':</td>
<td class="text-left">No</td>
<td class="text-left">such</td>
<td class="text-left">file</td>
<td class="text-left">or</td>
<td class="text-left">directory</td>
</tr>

<tr>
<td class="text-left">ye53nis@ara-login01.rz.uni-jena.de's</td>
<td class="text-left">password:</td>
<td class="text-left">&#xa0;</td>
<td class="text-left">&#xa0;</td>
<td class="text-left">&#xa0;</td>
<td class="text-left">&#xa0;</td>
<td class="text-left">&#xa0;</td>
<td class="text-left">&#xa0;</td>
<td class="text-left">&#xa0;</td>
</tr>

<tr>
<td class="text-left">/tmp/tmux-67339/default</td>
<td class="text-left">&#xa0;</td>
<td class="text-left">&#xa0;</td>
<td class="text-left">&#xa0;</td>
<td class="text-left">&#xa0;</td>
<td class="text-left">&#xa0;</td>
<td class="text-left">&#xa0;</td>
<td class="text-left">&#xa0;</td>
<td class="text-left">&#xa0;</td>
</tr>

<tr>
<td class="text-left">&gt;</td>
<td class="text-left">ye53nis@ara-login01.rz.uni-jena.de's</td>
<td class="text-left">password:</td>
<td class="text-left">&#xa0;</td>
<td class="text-left">&#xa0;</td>
<td class="text-left">&#xa0;</td>
<td class="text-left">&#xa0;</td>
<td class="text-left">&#xa0;</td>
<td class="text-left">&#xa0;</td>
</tr>
</tbody>
</table>

<p>
A script which allows to print the output from the tmux session
in an <code>#+begin_example</code>-Block below the tmux block by pressing <code>C-c C-o</code> or <code>C-c
C-v C-o</code> when the pointer is inside the tmux block. See <a href="https://github.com/ahendriksen/ob-tmux/issues/6#issuecomment-613914400">here</a>.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #859900; font-weight: bold;">defun</span> <span style="color: #268bd2;">ob-tmux--insert-result</span> ()
  (<span style="color: #859900; font-weight: bold;">interactive</span>)
  (<span style="color: #859900; font-weight: bold;">let</span> ((info (org-babel-get-src-block-info 'light)))
    (<span style="color: #859900; font-weight: bold;">when</span> (<span style="color: #859900; font-weight: bold;">and</span> info (string-equal <span style="color: #2aa198;">"tmux"</span> (nth 0 info)))
      (<span style="color: #859900; font-weight: bold;">let*</span> ((params (nth 2 info))
             (org-session (cdr (assq <span style="color: #839496; font-weight: bold;">:session</span> params)))
             (socket (cdr (assq <span style="color: #839496; font-weight: bold;">:socket</span> params)))
             (socket (<span style="color: #859900; font-weight: bold;">when</span> socket (expand-file-name socket)))
             (ob-session (ob-tmux--from-org-session org-session socket)))
        (org-babel-insert-result
             (ob-tmux--execute-string ob-session
                                      <span style="color: #2aa198;">"capture-pane"</span>
                                      <span style="color: #2aa198;">"-p"</span> <span style="color: #586e75;">;; </span><span style="color: #586e75;">print to stdout</span>
                                      <span style="color: #2aa198;">"-S"</span> <span style="color: #2aa198;">"-"</span> <span style="color: #586e75;">;; </span><span style="color: #586e75;">start at beginning of history</span>
                                      <span style="color: #2aa198;">"-t"</span> (ob-tmux--session ob-session))
             '(<span style="color: #2aa198;">"replace"</span>))))))

(<span style="color: #859900; font-weight: bold;">defun</span> <span style="color: #268bd2;">ob-tmux--edit-result</span> ()
  (<span style="color: #859900; font-weight: bold;">interactive</span>)
  (<span style="color: #859900; font-weight: bold;">pcase</span> (org-babel-get-src-block-info 'light)
    (`(,_ ,_ ,arguments ,_ ,_ ,start ,_)
     (<span style="color: #859900; font-weight: bold;">save-excursion</span>
       <span style="color: #586e75;">;; </span><span style="color: #586e75;">Go to the results, if there aren't any then run the block.</span>
       (goto-char start)
       (goto-char (<span style="color: #859900; font-weight: bold;">or</span> (org-babel-where-is-src-block-result)
                      (<span style="color: #859900; font-weight: bold;">progn</span> (org-babel-execute-src-block)
                             (org-babel-where-is-src-block-result))))
       (end-of-line)
       (skip-chars-forward <span style="color: #2aa198;">" \r\t\n"</span>)
       (org-edit-special)
       (delete-trailing-whitespace)
       (end-of-buffer)
       t))
    (_ nil)))

(<span style="color: #859900; font-weight: bold;">defun</span> <span style="color: #268bd2;">ob-tmux--open-src-block-result</span> (orig-fun <span style="color: #b58900;">&amp;rest</span> args)
  (<span style="color: #859900; font-weight: bold;">let</span> ((info (org-babel-get-src-block-info 'light)))
    (<span style="color: #859900; font-weight: bold;">if</span> (<span style="color: #859900; font-weight: bold;">and</span> info (string-equal <span style="color: #2aa198;">"tmux"</span> (nth 0 info)))
        (<span style="color: #859900; font-weight: bold;">progn</span>
          (ob-tmux--insert-result)
          (ob-tmux--edit-result))
      (apply orig-fun args))))

(advice-add 'org-babel-open-src-block-result
               <span style="color: #839496; font-weight: bold;">:around</span> #'ob-tmux--open-src-block-result)
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-2-1-4" class="outline-4">
<h4 id="sec-2-1-4"><span class="section-number-4">2.1.4</span> jupyter setup and ssh tunneling</h4>
<div class="outline-text-4" id="text-2-1-4">
<p>
On the compute node of the HPC, the users' environment is managed through module
files using the system <a href="https://lmod.readthedocs.io">Lmod</a>. The <code>export XDG_RUNTIME_DIR</code> statements are needed
because of a jupyter bug which did not let it start. Right now, <code>ob-tmux</code> does
not support a <code>:var</code> header like normal <code>org-babel</code> does. So the <code>$port</code>
variable has to be set before calling a block similar to this one:
</p>

<div class="org-src-container">

<pre class="src src-tmux"><span style="color: #839496; font-weight: bold;">export</span> <span style="color: #268bd2;">PORT</span>=8889
</pre>
</div>

<p>
Then call:
</p>

<div class="org-src-container">

<pre class="src src-tmux" id="jpt-tmux">module load tools/python/3.7
<span style="color: #839496; font-weight: bold;">export</span> <span style="color: #268bd2;">XDG_RUNTIME_DIR</span>=<span style="color: #2aa198;">''</span>
<span style="color: #839496; font-weight: bold;">export</span> <span style="color: #268bd2;">XDG_RUNTIME_DIR</span>=<span style="color: #2aa198;">""</span>
jupyter notebook --no-browser --port=$<span style="color: #268bd2;">PORT</span>
</pre>
</div>

<p>
Now this port has to be tunnelled on our local computer. While the tmux session
above keeps running, no matter if Emacs is running or not, this following ssh
tunnel needs to be active locally to connect to the notebook. If Emacs crashes,
it would need to be reestablished.
</p>

<div class="org-src-container">

<pre class="src src-sh" id="jpt-tunnel">ssh -t -t ara -L $<span style="color: #268bd2;">port</span>:localhost:$<span style="color: #268bd2;">port</span> ssh $<span style="color: #268bd2;">node</span> -L $<span style="color: #268bd2;">port</span>:Localhost:$<span style="color: #268bd2;">port</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-2-1-5" class="outline-4">
<h4 id="sec-2-1-5"><span class="section-number-4">2.1.5</span> Notes:</h4>
<div class="outline-text-4" id="text-2-1-5">
<p>
######################
</p>
</div>
</div>
</div>
</div>

<div id="outline-container-sec-3" class="outline-2">
<h2 id="sec-3"><span class="section-number-2">3</span> Organization of git</h2>
<div class="outline-text-2" id="text-3">
</div><div id="outline-container-sec-3-1" class="outline-3">
<h3 id="sec-3-1"><span class="section-number-3">3.1</span> remote/origin/master branch:</h3>
<div class="outline-text-3" id="text-3-1">
<ul class="org-ul">
<li>contains all the source code in folder <b><b>src/</b></b> which is used for experiments.
</li>
<li>contains the <b><b>LabBook.org</b></b> template
</li>
<li>contains setup- and metadata files such as <b><b>MLproject</b></b> or <b><b>conda.yaml</b></b>
</li>
<li>the log contains only lasting alterations on the folders and files mentioned
above, which are e.g. used for conducting experiments or which introduce new
features. Day-to-day changes in code
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-3-2" class="outline-3">
<h3 id="sec-3-2"><span class="section-number-3">3.2</span> remote/origin/exp### branches:</h3>
<div class="outline-text-3" id="text-3-2">
<ul class="org-ul">
<li>if an experiment is done, the code and templates will be branched out from
<b>master</b> in an <b>exp###</b> branch, ### meaning some meaningful descriptor.
</li>
<li>all data generated during the experiment (e.g. .csv files, plots, images,
etc), is stored in a folder with the name <b><b>data/exp-###</b></b>, except machine
learning-specific data and metadata from `mlflow` runs, which are saved
under <b><b>data/mlruns</b></b> (this allows easily comparing machine learning runs
with different experimental settings)
</li>
<li>The <b><b>LabBook.org</b></b> file is essential
<ul class="org-ul">
<li>If possible, all code is executed from inside this file (meaning analysis
scripts or calling the code from the <b><b>scr/</b></b> directory).
</li>
<li>All other steps taken during an experiment are noted down, as well as
conclusions or my thought process while conducting the experiment
</li>
<li>Provenance data, such as Metadata about the environment the code was
executed in, the command line output of the code, and some
</li>
</ul>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-3-3" class="outline-3">
<h3 id="sec-3-3"><span class="section-number-3">3.3</span> remote/origin/develop branch:</h3>
<div class="outline-text-3" id="text-3-3">
<ul class="org-ul">
<li>this is the branch I use for day to day work on features and exploration.
All of my current activity can be followed here.
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-3-4" class="outline-3">
<h3 id="sec-3-4"><span class="section-number-3">3.4</span> remote/origin/data branch:</h3>
<div class="outline-text-3" id="text-3-4">
<ul class="org-ul">
<li>contains a full cronicle of the whole research process
</li>
<li>all <b>exp###</b> branches are merged here. Afterwards the original branch is
deleted and on the data branch there is a <b>Git tag</b> which shows the merge
commit to make accessing single experiments easy.
</li>
<li>the <b>develop</b> branch is merged here as well.
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-3-5" class="outline-3">
<h3 id="sec-3-5"><span class="section-number-3">3.5</span> Git TAGs</h3>
<div class="outline-text-3" id="text-3-5">
</div><div id="outline-container-sec-3-5-1" class="outline-4">
<h4 id="sec-3-5-1"><span class="section-number-4">3.5.1</span> Stable versions:</h4>
</div>
<div id="outline-container-sec-3-5-2" class="outline-4">
<h4 id="sec-3-5-2"><span class="section-number-4">3.5.2</span> All tags from git:</h4>
<div class="outline-text-4" id="text-3-5-2">
<div class="org-src-container">

<pre class="src src-sh">git push origin --tags
git tag -n1
</pre>
</div>

<pre class="example">
exp-200402-test Merge branch 'exp-200402-test' into data
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-sec-4" class="outline-2">
<h2 id="sec-4"><span class="section-number-2">4</span> Organization of code</h2>
<div class="outline-text-2" id="text-4">
</div><div id="outline-container-sec-4-1" class="outline-3">
<h3 id="sec-4-1"><span class="section-number-3">4.1</span> scripts:</h3>
</div>
<div id="outline-container-sec-4-2" class="outline-3">
<h3 id="sec-4-2"><span class="section-number-3">4.2</span> src/</h3>
<div class="outline-text-3" id="text-4-2">
</div><div id="outline-container-sec-4-2-1" class="outline-4">
<h4 id="sec-4-2-1"><span class="section-number-4">4.2.1</span> fluotracify/</h4>
<div class="outline-text-4" id="text-4-2-1">
</div><ol class="org-ol"><li><a id="sec-4-2-1-1" name="sec-4-2-1-1"></a>imports/<br ></li>
<li><a id="sec-4-2-1-2" name="sec-4-2-1-2"></a>simulations/<br ></li>
<li><a id="sec-4-2-1-3" name="sec-4-2-1-3"></a>training/<br ></li>
<li><a id="sec-4-2-1-4" name="sec-4-2-1-4"></a>applications/<br ></li>
<li><a id="sec-4-2-1-5" name="sec-4-2-1-5"></a>doc/<br ><div class="outline-text-5" id="text-4-2-1-5">
<ul class="org-ul">
<li>use Sphinx
<ul class="org-ul">
<li>follow this: <a href="https://daler.github.io/sphinxdoc-test/includeme.html">https://daler.github.io/sphinxdoc-test/includeme.html</a>
</li>
<li>evtl export org-mode Readme to rst via <a href="https://github.com/msnoigrs/ox-rst">https://github.com/msnoigrs/ox-rst</a>
</li>
<li>possibly heavily use
<a href="http://www.sphinx-doc.org/en/master/usage/extensions/autodoc.html">http://www.sphinx-doc.org/en/master/usage/extensions/autodoc.html</a>
</li>
</ul>
</li>
<li>for examples sphinx-galleries could be useful
<a href="https://sphinx-gallery.github.io/stable/getting_started.html">https://sphinx-gallery.github.io/stable/getting_started.html</a>
</li>
</ul>
</div>
</li></ol>
</div>

<div id="outline-container-sec-4-2-2" class="outline-4">
<h4 id="sec-4-2-2"><span class="section-number-4">4.2.2</span> nanosimpy/</h4>
<div class="outline-text-4" id="text-4-2-2">
<ul class="org-ul">
<li>cloned from dwaithe with refactoring for Python 3-compatibility
</li>
</ul>
</div>
</div>
</div>
</div>

<div id="outline-container-sec-5" class="outline-2">
<h2 id="sec-5"><span class="section-number-2">5</span> Changes in this repository (without "* Data" in this file)</h2>
<div class="outline-text-2" id="text-5">
</div><div id="outline-container-sec-5-1" class="outline-3">
<h3 id="sec-5-1"><span class="section-number-3">5.1</span> Changes in LabBook.org (without "* Data")</h3>
<div class="outline-text-3" id="text-5-1">
</div><div id="outline-container-sec-5-1-1" class="outline-4">
<h4 id="sec-5-1-1"><span class="section-number-4">5.1.1</span> 2020-04-22</h4>
<div class="outline-text-4" id="text-5-1-1">
<ul class="org-ul">
<li>added parts of README which describe the experimental process
</li>
<li>added templates for system metadata, tmux, jupyter setup
</li>
<li>added organization of code
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-5-1-2" class="outline-4">
<h4 id="sec-5-1-2"><span class="section-number-4">5.1.2</span> 2020-03-30</h4>
<div class="outline-text-4" id="text-5-1-2">
<ul class="org-ul">
<li>set up lab book and form git repo accoring to setup by Luka Stanisic et al
</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-sec-5-2" class="outline-3">
<h3 id="sec-5-2"><span class="section-number-3">5.2</span> Changes in src/fluotracify</h3>
</div>
</div>

<div id="outline-container-sec-6" class="outline-2">
<h2 id="sec-6"><span class="section-number-2">6</span> DEVELOPMENT TESTING (don't merge in master)</h2>
<div class="outline-text-2" id="text-6">
</div>
<div id="outline-container-sec-6-1" class="outline-3">
<h3 id="sec-6-1"><span class="section-number-3">6.1</span> configured custom yasnippets,</h3>
<div class="outline-text-3" id="text-6-1">
<ul class="org-ul">
<li>check <code>yas-describe-tables</code> for current snippets
</li>
<li>use <code>C-c &amp; C-n</code> to create new snippet (its put in <code>.emacs.d/snippets/</code>)
</li>
</ul>

<div class="org-src-container">

<pre class="src src-sh">ls -Rl ~/.emacs.d/snippets/
</pre>
</div>

<table class="table table-striped table-bordered table-hover table-condensed">


<colgroup>
<col  class="left">

<col  class="left">

<col  class="right">

<col  class="right">

<col  class="left">
</colgroup>
<tbody>
<tr>
<td class="text-left"><i>home/lex</i>.emacs.d/snippets/:</td>
<td class="text-left">&#xa0;</td>
<td class="text-right">&#xa0;</td>
<td class="text-right">&#xa0;</td>
<td class="text-left">&#xa0;</td>
</tr>

<tr>
<td class="text-left">total</td>
<td class="text-left">&#xa0;</td>
<td class="text-right">&#xa0;</td>
<td class="text-right">&#xa0;</td>
<td class="text-left">&#xa0;</td>
</tr>

<tr>
<td class="text-left">drwxr-xr-x</td>
<td class="text-left">Apr</td>
<td class="text-right">23</td>
<td class="text-right">15:23</td>
<td class="text-left">org-mode</td>
</tr>

<tr>
<td class="text-left"><i>home/lex</i>.emacs.d/snippets/org-mode:</td>
<td class="text-left">&#xa0;</td>
<td class="text-right">&#xa0;</td>
<td class="text-right">&#xa0;</td>
<td class="text-left">&#xa0;</td>
</tr>

<tr>
<td class="text-left">total</td>
<td class="text-left">&#xa0;</td>
<td class="text-right">&#xa0;</td>
<td class="text-right">&#xa0;</td>
<td class="text-left">&#xa0;</td>
</tr>

<tr>
<td class="text-left">-rw-r&#x2013;r--</td>
<td class="text-left">Apr</td>
<td class="text-right">23</td>
<td class="text-right">14:32</td>
<td class="text-left">jupyter-python-block</td>
</tr>

<tr>
<td class="text-left">-rw-r&#x2013;r--</td>
<td class="text-left">Apr</td>
<td class="text-right">23</td>
<td class="text-right">14:35</td>
<td class="text-left">jupyter-python-header</td>
</tr>

<tr>
<td class="text-left">-rw-r&#x2013;r--</td>
<td class="text-left">Apr</td>
<td class="text-right">23</td>
<td class="text-right">15:23</td>
<td class="text-left">lmod-srun</td>
</tr>

<tr>
<td class="text-left">-rw-r&#x2013;r--</td>
<td class="text-left">Apr</td>
<td class="text-right">23</td>
<td class="text-right">14:53</td>
<td class="text-left">src2</td>
</tr>

<tr>
<td class="text-left">-rw-r&#x2013;r--</td>
<td class="text-left">Apr</td>
<td class="text-right">23</td>
<td class="text-right">15:00</td>
<td class="text-left">tmux</td>
</tr>
</tbody>
</table>
</div>
</div>

<div id="outline-container-sec-6-2" class="outline-3">
<h3 id="sec-6-2"><span class="section-number-3">6.2</span> fix hardlinks of org-files outside <code>Dokumente/org</code></h3>
<div class="outline-text-3" id="text-6-2">
<div class="org-src-container">

<pre class="src src-sh"><span style="color: #839496; font-weight: bold;">cd</span> Dokumente/org/linkedfiles
ls -li
find / -samefile LabBook.org
</pre>
</div>

<pre class="example">
total 84
4992947 -rw-r--r-- 2 lex lex 11786 Apr 23 14:14 LabBook.org
 404446 -rw-r--r-- 1 lex lex 21544 Apr  4 22:53 LabBook.org~
 404411 -rw-r--r-- 2 lex lex 23355 Apr 20 01:44 lexbn-source.org
4328628 -rw-r--r-- 1 lex lex 20829 Apr 19 14:37 lexbn-source.org~

/home/lex/Dokumente/org/linkedfiles/LabBook.org
/home/lex/Programme/drmed-git/LabBook.org
</pre>
</div>
</div>

<div id="outline-container-sec-6-3" class="outline-3">
<h3 id="sec-6-3"><span class="section-number-3">6.3</span> connect LabBook to HPC with jupyter etc</h3>
<div class="outline-text-3" id="text-6-3">
</div>
<div id="outline-container-sec-6-3-1" class="outline-4">
<h4 id="sec-6-3-1"><span class="section-number-4">6.3.1</span> connect to compute node</h4>
<div class="outline-text-4" id="text-6-3-1">
<div class="org-src-container">

<pre class="src src-sh">ssh ara
</pre>
</div>

<pre class="example">
ssh: Could not resolve hostname ara: Name or service not known
</pre>


<div class="org-src-container">

<pre class="src src-sh">sinfo
</pre>
</div>

<table class="table table-striped table-bordered table-hover table-condensed">


<colgroup>
<col  class="left">

<col  class="left">

<col  class="right">

<col  class="right">

<col  class="left">

<col  class="left">
</colgroup>
<tbody>
<tr>
<td class="text-left">PARTITION</td>
<td class="text-left">AVAIL</td>
<td class="text-right">TIMELIMIT</td>
<td class="text-right">NODES</td>
<td class="text-left">STATE</td>
<td class="text-left">NODELIST</td>
</tr>

<tr>
<td class="text-left">b<sub>test</sub></td>
<td class="text-left">up</td>
<td class="text-right">3:00:00</td>
<td class="text-right">1</td>
<td class="text-left">idle</td>
<td class="text-left">node001</td>
</tr>

<tr>
<td class="text-left">b<sub>standard</sub>*</td>
<td class="text-left">up</td>
<td class="text-right">8-08:00:00</td>
<td class="text-right">48</td>
<td class="text-left">mix</td>
<td class="text-left">node[003,007-008,023-026,029,031,033-038,040,053,063-064,066-072,075-078,083-085,090-094,117-119,121-125,131,133]</td>
</tr>

<tr>
<td class="text-left">b<sub>standard</sub>*</td>
<td class="text-left">up</td>
<td class="text-right">8-08:00:00</td>
<td class="text-right">82</td>
<td class="text-left">alloc</td>
<td class="text-left">node[002,004-006,009-022,027-028,030,032,039,041-045,047-052,054-062,065,073-074,079-082,086-089,095-116,120,126,132,134-136]</td>
</tr>

<tr>
<td class="text-left">b<sub>standard</sub>*</td>
<td class="text-left">up</td>
<td class="text-right">8-08:00:00</td>
<td class="text-right">1</td>
<td class="text-left">idle</td>
<td class="text-left">node046</td>
</tr>

<tr>
<td class="text-left">gpu<sub>test</sub></td>
<td class="text-left">up</td>
<td class="text-right">1:00:00</td>
<td class="text-right">1</td>
<td class="text-left">idle</td>
<td class="text-left">node127</td>
</tr>

<tr>
<td class="text-left">gpu<sub>p100</sub></td>
<td class="text-left">up</td>
<td class="text-right">8-08:00:00</td>
<td class="text-right">2</td>
<td class="text-left">mix</td>
<td class="text-left">node[128-129]</td>
</tr>

<tr>
<td class="text-left">gpu<sub>v100</sub></td>
<td class="text-left">up</td>
<td class="text-right">8-08:00:00</td>
<td class="text-right">1</td>
<td class="text-left">idle</td>
<td class="text-left">node130</td>
</tr>

<tr>
<td class="text-left">b<sub>fat</sub></td>
<td class="text-left">up</td>
<td class="text-right">8-08:00:00</td>
<td class="text-right">4</td>
<td class="text-left">mix</td>
<td class="text-left">node[137-140]</td>
</tr>

<tr>
<td class="text-left">s<sub>test</sub></td>
<td class="text-left">up</td>
<td class="text-right">3:00:00</td>
<td class="text-right">1</td>
<td class="text-left">idle</td>
<td class="text-left">node141</td>
</tr>

<tr>
<td class="text-left">s<sub>standard</sub></td>
<td class="text-left">up</td>
<td class="text-right">8-08:00:00</td>
<td class="text-right">68</td>
<td class="text-left">mix</td>
<td class="text-left">node[144,151,162-163,167,169,171-172,177-181,186,191,196-198,200,203-209,212-214,216,218,221-222,224-231,233,235-237,241-249,255,257,259-260,265-268,297,303-304,309-310,315]</td>
</tr>

<tr>
<td class="text-left">s<sub>standard</sub></td>
<td class="text-left">up</td>
<td class="text-right">8-08:00:00</td>
<td class="text-right">83</td>
<td class="text-left">alloc</td>
<td class="text-left">node[142-143,145-150,152-161,164-166,168,170,173-176,182-185,187-190,192-195,199,201-202,210-211,215,217,219-220,223,232,234,238-240,250-254,256,258,261-264,293-296,298-302,305-308,311-314,316]</td>
</tr>

<tr>
<td class="text-left">s<sub>fat</sub></td>
<td class="text-left">up</td>
<td class="text-right">8-08:00:00</td>
<td class="text-right">3</td>
<td class="text-left">mix</td>
<td class="text-left">node[269-270,272]</td>
</tr>

<tr>
<td class="text-left">s<sub>fat</sub></td>
<td class="text-left">up</td>
<td class="text-right">8-08:00:00</td>
<td class="text-right">1</td>
<td class="text-left">alloc</td>
<td class="text-left">node271</td>
</tr>
</tbody>
</table>

<div class="org-src-container">

<pre class="src src-sh">tmux ls
</pre>
</div>

<table class="table table-striped table-bordered table-hover table-condensed">


<colgroup>
<col  class="right">

<col  class="right">

<col  class="left">

<col  class="left">

<col  class="left">

<col  class="left">

<col  class="right">

<col  class="right">

<col  class="right">
</colgroup>
<tbody>
<tr>
<td class="text-right">0:</td>
<td class="text-right">1</td>
<td class="text-left">windows</td>
<td class="text-left">(created</td>
<td class="text-left">Mon</td>
<td class="text-left">Apr</td>
<td class="text-right">13</td>
<td class="text-right">19:54:44</td>
<td class="text-right">2020</td>
</tr>

<tr>
<td class="text-right">ob-tmux:</td>
<td class="text-right">1</td>
<td class="text-left">windows</td>
<td class="text-left">(created</td>
<td class="text-left">Mon</td>
<td class="text-left">Apr</td>
<td class="text-right">13</td>
<td class="text-right">19:55:21</td>
<td class="text-right">2020</td>
</tr>
</tbody>
</table>


<table class="table table-striped table-bordered table-hover table-condensed">


<colgroup>
<col  class="left">

<col  class="left">

<col  class="left">
</colgroup>
<tbody>
<tr>
<td class="text-left">ye53nis@ara-login01.rz.uni-jena.de's</td>
<td class="text-left">password:</td>
<td class="text-left">&#xa0;</td>
</tr>

<tr>
<td class="text-left">/tmp/tmux-67339/default</td>
<td class="text-left">&#xa0;</td>
<td class="text-left">&#xa0;</td>
</tr>

<tr>
<td class="text-left">&gt;</td>
<td class="text-left">ye53nis@ara-login01.rz.uni-jena.de's</td>
<td class="text-left">password:</td>
</tr>
</tbody>
</table>

<div class="org-src-container">

<pre class="src src-tmux"><span style="color: #839496; font-weight: bold;">echo</span> test
</pre>
</div>

<pre class="example">
[ye53nis@login01 ~]$ echo test
test
[ye53nis@login01 ~]$
</pre>

<div class="org-src-container">

<pre class="src src-tmux">srun -p b_standard --time=7-10:00:00 --ntasks-per-node 48 --pty bash
</pre>
</div>

<pre class="example">
[ye53nis@login01 ~]$ srun -p b_standard --time=7-10:00:00 --ntasks-per-node 48 -
-pty bash
[ye53nis@node018 ~]$
</pre>
</div>
</div>

<div id="outline-container-sec-6-3-2" class="outline-4">
<h4 id="sec-6-3-2"><span class="section-number-4">6.3.2</span> start and connect to jupyter</h4>
<div class="outline-text-4" id="text-6-3-2">
<div class="org-src-container">

<pre class="src src-tmux"><span style="color: #839496; font-weight: bold;">export</span> <span style="color: #268bd2;">PORT</span>=8889
</pre>
</div>


<pre class="example">
[ye53nis@node007 drmed-git]$ export PORT=8889
[ye53nis@node007 drmed-git]$ module load tools/python/3.7
[ye53nis@node007 drmed-git]$ export XDG_RUNTIME_DIR=''
[ye53nis@node007 drmed-git]$ export XDG_RUNTIME_DIR=""
[ye53nis@node007 drmed-git]$ jupyter notebook --no-browser --port=$PORT
[I 16:44:59.413 NotebookApp] Serving notebooks from local directory: /beegfs/ye53nis/drmed-git
[I 16:44:59.413 NotebookApp] The Jupyter Notebook is running at:
[I 16:44:59.413 NotebookApp] http://localhost:8889/?token=552a9cff48203d5a263cb083b80b939dbbc856758df651dd
[I 16:44:59.413 NotebookApp] Use Control-C to stop this server and shut down all kernels (twice to skip confirmation).
[C 16:44:59.425 NotebookApp]

    To access the notebook, open this file in a browser:
        file:///home/ye53nis/.local/share/jupyter/runtime/nbserver-84165-open.html
    Or copy and paste one of these URLs:
        http://localhost:8889/?token=552a9cff48203d5a263cb083b80b939dbbc856758df651dd
</pre>

<table class="table table-striped table-bordered table-hover table-condensed">


<colgroup>
<col  class="left">

<col  class="left">

<col  class="left">

<col  class="right">

<col  class="left">

<col  class="right">

<col  class="left">

<col  class="left">

<col  class="left">

<col  class="left">

<col  class="left">
</colgroup>
<tbody>
<tr>
<td class="text-left">Connection</td>
<td class="text-left">closed</td>
<td class="text-left">by</td>
<td class="text-right">10.138.225.252</td>
<td class="text-left">port</td>
<td class="text-right">22</td>
<td class="text-left">&#xa0;</td>
<td class="text-left">&#xa0;</td>
<td class="text-left">&#xa0;</td>
<td class="text-left">&#xa0;</td>
<td class="text-left">&#xa0;</td>
</tr>

<tr>
<td class="text-left">sh-5.0$</td>
<td class="text-left">ye53nis@ara-login01.rz.uni-jena.de's</td>
<td class="text-left">password:</td>
<td class="text-right">&#xa0;</td>
<td class="text-left">&#xa0;</td>
<td class="text-right">&#xa0;</td>
<td class="text-left">&#xa0;</td>
<td class="text-left">&#xa0;</td>
<td class="text-left">&#xa0;</td>
<td class="text-left">&#xa0;</td>
<td class="text-left">&#xa0;</td>
</tr>

<tr>
<td class="text-left">Warning:</td>
<td class="text-left">Permanently</td>
<td class="text-left">added</td>
<td class="text-right">'node007,192.168.193.7'</td>
<td class="text-left">(ECDSA)</td>
<td class="text-right">to</td>
<td class="text-left">the</td>
<td class="text-left">list</td>
<td class="text-left">of</td>
<td class="text-left">known</td>
<td class="text-left">hosts.</td>
</tr>

<tr>
<td class="text-left">ye53nis@node007's</td>
<td class="text-left">password:</td>
<td class="text-left">&#xa0;</td>
<td class="text-right">&#xa0;</td>
<td class="text-left">&#xa0;</td>
<td class="text-right">&#xa0;</td>
<td class="text-left">&#xa0;</td>
<td class="text-left">&#xa0;</td>
<td class="text-left">&#xa0;</td>
<td class="text-left">&#xa0;</td>
<td class="text-left">&#xa0;</td>
</tr>
</tbody>
</table>

<p>
I started a Python3 kernel using <code>jupyter-server-list-kernels</code>. Then I added the
kernel ID to the <code>:PROPERTIES:</code> drawer of this (and following) subtrees.
</p>

<pre class="example">
python3           2912b27f-1dbe-4a8e-9c59-6cc02f5434cf   2 minutes ago        starting   0
</pre>

<p>
Passing a boolean value to a variable in <code>org-babel</code> was not trivial: you have to
use the infamous <b>single quote '</b> from emacs-lisp programming to show that the
expression should be returned as written, not evaluated.
</p>

<pre class="example">
No of CPUs in system: 48
No of CPUs the current process can use: 48
load average: (0.08, 0.03, 0.05)
posix.uname_result(sysname='Linux', nodename='node007', release='3.10.0-957.1.3.el7.x86_64', version='#1 SMP Thu Nov 29 14:49:43 UTC 2018', machine='x86_64')
PID of process: 92855
RAM total: 137G, RAM used: 1.3G, RAM free: 120G
the current directory: /beegfs/ye53nis/drmed-git
My disk usage:
Filesystem           Size  Used Avail Use% Mounted on
/dev/sda1             50G  4.3G   46G   9% /
devtmpfs              63G     0   63G   0% /dev
tmpfs                 63G  199M   63G   1% /dev/shm
tmpfs                 63G   59M   63G   1% /run
tmpfs                 63G     0   63G   0% /sys/fs/cgroup
nfs01-ib:/cluster    2.0T  316G  1.7T  16% /cluster
nfs01-ib:/home        80T   59T   22T  73% /home
nfs03-ib:/pool/work  100T   78T   23T  78% /nfsdata
/dev/sda3            6.0G  441M  5.6G   8% /var
/dev/sda5            2.0G   34M  2.0G   2% /tmp
/dev/sda6            169G  5.5G  163G   4% /local
beegfs_nodev         524T  427T   98T  82% /beegfs
tmpfs                 13G     0   13G   0% /run/user/67339
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-6-4" class="outline-3">
<h3 id="sec-6-4"><span class="section-number-3">6.4</span> set up mlflow</h3>
<div class="outline-text-3" id="text-6-4">
<p>
:header-args:jupyter-python: :session /jpy:localhost#8889:6be3aedd-62d4-4fc2-b816-af41e3986de9
</p>
</div>

<div id="outline-container-sec-6-4-1" class="outline-4">
<h4 id="sec-6-4-1"><span class="section-number-4">6.4.1</span> how do I submit mlflow jobs?</h4>
<div class="outline-text-4" id="text-6-4-1">
<ul class="org-ul">
<li>I will need two sessions
<ul class="org-ul">
<li>one <b>tmux session</b> for running the jupyter kernel, having a REPL, fast and
interactive coding. I need tmux bc the connection to the node would break if
I log out of ssh.
<div class="org-src-container">

<pre class="src src-tmux"><span style="color: #839496; font-weight: bold;">echo</span> t&#252;del&#252;
</pre>
</div>
</li>
<li>one <b>sh ssh session</b> for sending command line commands. SLURM handles the
job and outputs files - so it should continue, even if I log out
</li>
</ul>
</li>
<li>alternative solution: tmux windows (<b>note: after using tmux windows, the
normal <code>:session tmux</code> without window specification doesn't work anymore</b>)
<ul class="org-ul">
<li>this is window <code>mlflow</code> for sending mlflow commands. we have to request some
computation power by SLURM again
<div class="org-src-container">

<pre class="src src-tmux"><span style="color: #839496; font-weight: bold;">echo</span> pwd
</pre>
</div>
</li>
<li>this is window <code>ob1</code> (name automatically created when you don't specify a
window name) where our jupyter kernel runs:
<div class="org-src-container">

<pre class="src src-tmux"><span style="color: #839496; font-weight: bold;">echo</span> test&#246;
</pre>
</div>
</li>
</ul>
</li>
</ul>
</div>
<ol class="org-ol"><li><a id="sec-6-4-1-1" name="sec-6-4-1-1"></a>Failed approaches:<br ><div class="outline-text-5" id="text-6-4-1-1">
<ul class="org-ul">
<li>then jobs are submitted e.g. as bash scripts (this is just an example from the
wiki):
<div class="org-src-container">

<pre class="src src-sh"><span style="color: #586e75;">#</span><span style="color: #586e75;">!/bin/</span><span style="color: #859900; font-weight: bold;">bash</span>
<span style="color: #586e75;">#</span><span style="color: #586e75;">SBATCH --job-name=pc1-intro</span>
<span style="color: #586e75;">#</span><span style="color: #586e75;">SBATCH --partition=s_standard</span>
<span style="color: #586e75;">#</span><span style="color: #586e75;">SBATCH --nodes=4</span>
<span style="color: #586e75;">#</span><span style="color: #586e75;">SBATCH --ntasks-per-node=36</span>
<span style="color: #586e75;">#</span><span style="color: #586e75;">SBATCH --time=1:00</span>
module purge
module load tools/python/3.7 mpi/intel/2019-Update5
srun python intro.py
</pre>
</div>
</li>
<li>test:
<div class="org-src-container">

<pre class="src src-sh" id="sh-test-script"><span style="color: #586e75;">#</span><span style="color: #586e75;">SBATCH --job-name=pc1-intro</span>
<span style="color: #586e75;">#</span><span style="color: #586e75;">SBATCH --partition=s_test</span>
<span style="color: #586e75;">#</span><span style="color: #586e75;">SBATCH --nodes=1</span>
hostname
</pre>
</div>
</li>
</ul>

<div class="org-src-container">

<pre class="src src-tmux">sbatch <span style="color: #586e75;">#</span><span style="color: #586e75;">SBATCH --job-name=pc1-intro</span>
sbatch <span style="color: #586e75;">#</span><span style="color: #586e75;">SBATCH --partition=s_test</span>
sbatch <span style="color: #586e75;">#</span><span style="color: #586e75;">SBATCH --nodes=1</span>
sbatch hostname
</pre>
</div>

<div class="org-src-container">

<pre class="src src-sh">sbatch <span style="color: #586e75;">#</span><span style="color: #586e75;">SBATCH --job-name=pc1-intro</span>
sbatch <span style="color: #586e75;">#</span><span style="color: #586e75;">SBATCH --partition=s_test</span>
sbatch <span style="color: #586e75;">#</span><span style="color: #586e75;">SBATCH --nodes=1</span>
sbatch hostname
</pre>
</div>

<table class="table table-striped table-bordered table-hover table-condensed">


<colgroup>
<col  class="left">
</colgroup>
<tbody>
<tr>
<td class="text-left">&#xa0;</td>
</tr>

<tr>
<td class="text-left">sbatch: error: Unable to open file sh-test-script</td>
</tr>
</tbody>
</table>

<p>
Note: t
</p>
</div>
</li>

<li><a id="sec-6-4-1-2" name="sec-6-4-1-2"></a>Note: do it like for jupyter: srun a bash script, then execute mlflow<br ></li></ol>
</div>
<div id="outline-container-sec-6-4-2" class="outline-4">
<h4 id="sec-6-4-2"><span class="section-number-4">6.4.2</span> Reading the docs: mlflow</h4>
<div class="outline-text-4" id="text-6-4-2">
<ul class="org-ul">
<li>searched for papers, found <a href="http://sites.computer.org/debull/A18dec/A18DEC-CD.pdf#page=41">two</a> <a href="https://mlsys.org/Conferences/2019/doc/2019/demo_33.pdf">papers</a>, but they don't seem very exhaustive.
</li>
<li>took notes <a href="file:///home/lex/Dokumente/org/04_Digital-und-Technik/programmieren.html#MissingReference">here</a>
</li>
<li>shall I keep MLflow files in a folder inside the <code>data/exp#</code> folder for each
experiment or do a central <code>data/mlflow</code> folder?  I tend towards the second
option. MLflow has an environment variable <code>MLFLOW_EXPERIMENT_NAME</code> which
would be the same as <code>exp#</code>.
</li>
<li>Inside the folder, should I use "normal" files or a database for saving stuff?
 I tend towards normal files, since I have no experiments with databases..
</li>
<li>MLflow Tracking Service API might be useful for accessing the results from
inside org documents.
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-6-4-3" class="outline-4">
<h4 id="sec-6-4-3"><span class="section-number-4">6.4.3</span> Reading Barredo Arrieta et al: Explainable Artificial Intelligence (XIA)</h4>
</div>
<div id="outline-container-sec-6-4-4" class="outline-4">
<h4 id="sec-6-4-4"><span class="section-number-4">6.4.4</span> Set up git on HPC</h4>
<div class="outline-text-4" id="text-6-4-4">
<div class="org-src-container">

<pre class="src src-tmux">git clone https://github.com/aseltmann/fluotracify
</pre>
</div>

<p>
Wanted to git pull my repository on HPC, noticed that it already exists - and
has uncommited changes. Have to sort that out.
</p>

<p>
Git runs now on HPC, but had to resolve merge conflicts in code  used <b>Magit</b>
and especially Ediff. Watched these resources:
</p>
<ul class="org-ul">
<li><a href="https://www.youtube.com/watch?v=9S2pMZ6U5Tc&amp;t=715s">https://www.youtube.com/watch?v=9S2pMZ6U5Tc&amp;t=715s</a> - short resource on smerge
and ediff
</li>
<li><a href="https://www.youtube.com/watch?v=j-k-lkilbEs">https://www.youtube.com/watch?v=j-k-lkilbEs</a> - nice intro to magit in general
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-6-4-5" class="outline-4">
<h4 id="sec-6-4-5"><span class="section-number-4">6.4.5</span> run mlflow test</h4>
<div class="outline-text-4" id="text-6-4-5">
</div><ol class="org-ol"><li><a id="sec-6-4-5-1" name="sec-6-4-5-1"></a>Use a local tmux session:<br ><div class="outline-text-5" id="text-6-4-5-1">
<div class="org-src-container">

<pre class="src src-tmux"><span style="color: #839496; font-weight: bold;">pwd</span>
</pre>
</div>

<pre class="example">
(base) [lex@Topialex ~]$ pwd
/home/lex
</pre>

<div class="org-src-container">

<pre class="src src-tmux"><span style="color: #839496; font-weight: bold;">export</span> <span style="color: #268bd2;">MLFLOW_EXPERIMENT_NAME</span>=exp-devtest
<span style="color: #839496; font-weight: bold;">export</span> <span style="color: #268bd2;">MLFLOW_EXPERIMENT_ID</span>=0.1
<span style="color: #839496; font-weight: bold;">export</span> <span style="color: #268bd2;">MLFLOW_TRACKING_URI</span>=file:./data/mlruns
</pre>
</div>

<div class="org-src-container">

<pre class="src src-tmux">conda activate tensorflow_env
</pre>
</div>

<pre class="example">
(base) [lex@Topialex ~]$ conda activate tensorflow_env
(tensorflow_env) [lex@Topialex ~]$
</pre>

<div class="org-src-container">

<pre class="src src-tmux">mlflow run .
</pre>
</div>

<pre class="example">
(tensorflow_env) [lex@Topialex ~]$ mlflow run .
Specify only one of 'experiment-name' or 'experiment-id' options.
(tensorflow_env) [lex@Topialex ~]$
</pre>

<div class="org-src-container">

<pre class="src src-tmux"><span style="color: #839496; font-weight: bold;">export</span> <span style="color: #268bd2;">MLFLOW_EXPERIMENT_NAME</span>=exp-devtest
<span style="color: #839496; font-weight: bold;">export</span> <span style="color: #268bd2;">MLFLOW_TRACKING_URI</span>=file:./data/mlruns
</pre>
</div>

<div class="org-src-container">

<pre class="src src-tmux">conda activate tensorflow_env
</pre>
</div>

<pre class="example">
(base) [lex@Topialex ~]$ conda activate tensorflow_env
(tensorflow_env) [lex@Topialex ~]$
</pre>

<div class="org-src-container">

<pre class="src src-tmux">mlflow run /home/lex/Programme/drmed-git/
</pre>
</div>

<pre class="example">
(tensorflow_env) [lex@Topialex ~]$ mlflow run /home/lex/Programme/drmed-git/
2020/04/28 01:17:01 INFO mlflow.projects: === Created directory /tmp/tmp_goyesz7
 for downloading remote URIs passed to arguments of type 'path' ===
2020/04/28 01:17:01 INFO mlflow.projects: === Running command 'source /home/lex/
Programme/miniconda3/bin/../etc/profile.d/conda.sh &amp;&amp; conda activate mlflow-1114
b06fb561908fc3f52e89d8342d7e52709c81 1&gt;&amp;2 &amp;&amp; python src/fluotracify/training/tra
in.py 5 0.2 16384 1e-5 10' in run with ID 'c0f7e64fdda64801860e9805948db29d' ===

/home/lex/Programme/miniconda3/envs/mlflow-1114b06fb561908fc3f52e89d8342d7e52709
c81/lib/python3.7/site-packages/tensorflow_core/python/pywrap_tensorflow_interna
l.py:15: DeprecationWarning: the imp module is deprecated in favour of importlib
; see the module's documentation for alternative uses
  import imp
2.1.0
train 0 /home/lex/Programme/Jupyter/DOKTOR/saves/firstartefact/subsample_rand/tr
aces_brightclust_rand_Sep2019_set003.csv
train 1 /home/lex/Programme/Jupyter/DOKTOR/saves/firstartefact/subsample_rand/tr
aces_brightclust_rand_Sep2019_set002.csv
test 2 /home/lex/Programme/Jupyter/DOKTOR/saves/firstartefact/subsample_rand/tra
ces_brightclust_rand_Sep2019_set001.csv
shapes of feature dataframe: (20000, 200) and label dataframe: (20000, 200)
shapes of feature dataframe: (20000, 100) and label dataframe: (20000, 100)

for each 20,000 timestap trace there are the following numbers of corrupted time
steps:
 label001_1     4124
label002_1     2261
label003_1       45
label004_1    13108
label005_1     2306
dtype: int64
2020-04-28 01:17:15.293658: I tensorflow/core/platform/cpu_feature_guard.cc:142]
 Your CPU supports instructions that this TensorFlow binary was not compiled to
use: SSE4.1 SSE4.2 AVX AVX2 FMA
2020-04-28 01:17:15.340845: I tensorflow/core/platform/profile_utils/cpu_utils.c
c:94] CPU Frequency: 2400500000 Hz
2020-04-28 01:17:15.342222: I tensorflow/compiler/xla/service/service.cc:168] XL
A service 0x5654fb291850 initialized for platform Host (this does not guarantee
that XLA will be used). Devices:
2020-04-28 01:17:15.342284: I tensorflow/compiler/xla/service/service.cc:176]
StreamExecutor device (0): Host, Default Version
2020-04-28 01:17:15.344811: I tensorflow/core/common_runtime/process_util.cc:147
] Creating new thread pool with default inter op setting: 2. Tune using inter_op
_parallelism_threads for best performance.
number of training examples: 160, number of validation examples: 40

------------------------
number of test examples: 100

Traceback (most recent call last):
  File "src/fluotracify/training/train.py", line 65, in &lt;module&gt;
    with mlflow.start_run():
  File "/home/lex/Programme/miniconda3/envs/mlflow-1114b06fb561908fc3f52e89d8342
d7e52709c81/lib/python3.7/site-packages/mlflow/tracking/fluent.py", line 122, in
 start_run
    active_run_obj = MlflowClient().get_run(existing_run_id)
  File "/home/lex/Programme/miniconda3/envs/mlflow-1114b06fb561908fc3f52e89d8342
d7e52709c81/lib/python3.7/site-packages/mlflow/tracking/client.py", line 96, in
get_run
    return self._tracking_client.get_run(run_id)
  File "/home/lex/Programme/miniconda3/envs/mlflow-1114b06fb561908fc3f52e89d8342
d7e52709c81/lib/python3.7/site-packages/mlflow/tracking/_tracking_service/client
.py", line 49, in get_run
    return self.store.get_run(run_id)
  File "/home/lex/Programme/miniconda3/envs/mlflow-1114b06fb561908fc3f52e89d8342
d7e52709c81/lib/python3.7/site-packages/mlflow/store/tracking/file_store.py", li
ne 423, in get_run
    run_info = self._get_run_info(run_id)
  File "/home/lex/Programme/miniconda3/envs/mlflow-1114b06fb561908fc3f52e89d8342
d7e52709c81/lib/python3.7/site-packages/mlflow/store/tracking/file_store.py", li
ne 442, in _get_run_info
    databricks_pb2.RESOURCE_DOES_NOT_EXIST)
mlflow.exceptions.MlflowException: Run 'c0f7e64fdda64801860e9805948db29d' not fo
und
Exception ignored in: &lt;function _RandomSeedGeneratorDeleter.__del__ at 0x7fb42c4
f4440&gt;
Traceback (most recent call last):
  File "/home/lex/Programme/miniconda3/envs/mlflow-1114b06fb561908fc3f52e89d8342
d7e52709c81/lib/python3.7/site-packages/tensorflow_core/python/data/ops/dataset_
ops.py", line 3462, in __del__
AttributeError: 'NoneType' object has no attribute 'device'
2020/04/28 01:17:16 ERROR mlflow.cli: === Run (ID 'c0f7e64fdda64801860e9805948db
29d') failed ===
(tensorflow_env) [lex@Topialex ~]$
</pre>
</div>
</li>

<li><a id="sec-6-4-5-2" name="sec-6-4-5-2"></a>use remote tmux<br ><div class="outline-text-5" id="text-6-4-5-2">
<div class="org-src-container">

<pre class="src src-sh">ssh ara
</pre>
</div>

<table class="table table-striped table-bordered table-hover table-condensed">


<colgroup>
<col  class="left">

<col  class="left">

<col  class="left">

<col  class="left">

<col  class="left">

<col  class="left">

<col  class="left">

<col  class="left">

<col  class="left">

<col  class="left">

<col  class="left">

<col  class="left">

<col  class="left">
</colgroup>
<tbody>
<tr>
<td class="text-left">Permission</td>
<td class="text-left">denied,</td>
<td class="text-left">please</td>
<td class="text-left">try</td>
<td class="text-left">again.</td>
<td class="text-left">&#xa0;</td>
<td class="text-left">&#xa0;</td>
<td class="text-left">&#xa0;</td>
<td class="text-left">&#xa0;</td>
<td class="text-left">&#xa0;</td>
<td class="text-left">&#xa0;</td>
<td class="text-left">&#xa0;</td>
<td class="text-left">&#xa0;</td>
</tr>

<tr>
<td class="text-left">ye53nis@ara-login01.rz.uni-jena.de's</td>
<td class="text-left">password:</td>
<td class="text-left">&#xa0;</td>
<td class="text-left">&#xa0;</td>
<td class="text-left">&#xa0;</td>
<td class="text-left">&#xa0;</td>
<td class="text-left">&#xa0;</td>
<td class="text-left">&#xa0;</td>
<td class="text-left">&#xa0;</td>
<td class="text-left">&#xa0;</td>
<td class="text-left">&#xa0;</td>
<td class="text-left">&#xa0;</td>
<td class="text-left">&#xa0;</td>
</tr>

<tr>
<td class="text-left">Last</td>
<td class="text-left">failed</td>
<td class="text-left">login:</td>
<td class="text-left">Tue</td>
<td class="text-left">Apr</td>
<td class="text-left">28</td>
<td class="text-left">11:05:11</td>
<td class="text-left">CEST</td>
<td class="text-left">2020</td>
<td class="text-left">from</td>
<td class="text-left">10.231.181.150</td>
<td class="text-left">on</td>
<td class="text-left">ssh:notty</td>
</tr>

<tr>
<td class="text-left">There</td>
<td class="text-left">was</td>
<td class="text-left">1</td>
<td class="text-left">failed</td>
<td class="text-left">login</td>
<td class="text-left">attempt</td>
<td class="text-left">since</td>
<td class="text-left">the</td>
<td class="text-left">last</td>
<td class="text-left">successful</td>
<td class="text-left">login.</td>
<td class="text-left">&#xa0;</td>
<td class="text-left">&#xa0;</td>
</tr>

<tr>
<td class="text-left">Last</td>
<td class="text-left">login:</td>
<td class="text-left">Tue</td>
<td class="text-left">Apr</td>
<td class="text-left">28</td>
<td class="text-left">10:57:34</td>
<td class="text-left">2020</td>
<td class="text-left">from</td>
<td class="text-left">10.231.181.150</td>
<td class="text-left">&#xa0;</td>
<td class="text-left">&#xa0;</td>
<td class="text-left">&#xa0;</td>
<td class="text-left">&#xa0;</td>
</tr>
</tbody>
</table>

<div class="org-src-container">

<pre class="src src-sh">sinfo
</pre>
</div>

<table class="table table-striped table-bordered table-hover table-condensed">


<colgroup>
<col  class="left">

<col  class="left">

<col  class="right">

<col  class="right">

<col  class="left">

<col  class="left">
</colgroup>
<tbody>
<tr>
<td class="text-left">PARTITION</td>
<td class="text-left">AVAIL</td>
<td class="text-right">TIMELIMIT</td>
<td class="text-right">NODES</td>
<td class="text-left">STATE</td>
<td class="text-left">NODELIST</td>
</tr>

<tr>
<td class="text-left">b<sub>test</sub></td>
<td class="text-left">up</td>
<td class="text-right">3:00:00</td>
<td class="text-right">1</td>
<td class="text-left">idle</td>
<td class="text-left">node001</td>
</tr>

<tr>
<td class="text-left">b<sub>standard</sub>*</td>
<td class="text-left">up</td>
<td class="text-right">8-08:00:00</td>
<td class="text-right">26</td>
<td class="text-left">mix</td>
<td class="text-left">node[005-006,008,014,018,025-026,029,031,039,043,046,063-064,070-071,085-086,108,110,120,126,132,134-136]</td>
</tr>

<tr>
<td class="text-left">b<sub>standard</sub>*</td>
<td class="text-left">up</td>
<td class="text-right">8-08:00:00</td>
<td class="text-right">96</td>
<td class="text-left">alloc</td>
<td class="text-left">node[002-004,009-013,015-017,019-024,027-028,030,032-037,040-042,045,047-062,065,067-068,072-082,084,087-107,109,111-116,119,121-125,131]</td>
</tr>

<tr>
<td class="text-left">b<sub>standard</sub>*</td>
<td class="text-left">up</td>
<td class="text-right">8-08:00:00</td>
<td class="text-right">9</td>
<td class="text-left">idle</td>
<td class="text-left">node[007,038,044,066,069,083,117-118,133]</td>
</tr>

<tr>
<td class="text-left">gpu<sub>test</sub></td>
<td class="text-left">up</td>
<td class="text-right">1:00:00</td>
<td class="text-right">1</td>
<td class="text-left">mix</td>
<td class="text-left">node127</td>
</tr>

<tr>
<td class="text-left">gpu<sub>p100</sub></td>
<td class="text-left">up</td>
<td class="text-right">8-08:00:00</td>
<td class="text-right">2</td>
<td class="text-left">mix</td>
<td class="text-left">node[128-129]</td>
</tr>

<tr>
<td class="text-left">gpu<sub>v100</sub></td>
<td class="text-left">up</td>
<td class="text-right">8-08:00:00</td>
<td class="text-right">1</td>
<td class="text-left">mix</td>
<td class="text-left">node130</td>
</tr>

<tr>
<td class="text-left">b<sub>fat</sub></td>
<td class="text-left">up</td>
<td class="text-right">8-08:00:00</td>
<td class="text-right">2</td>
<td class="text-left">mix</td>
<td class="text-left">node[139-140]</td>
</tr>

<tr>
<td class="text-left">b<sub>fat</sub></td>
<td class="text-left">up</td>
<td class="text-right">8-08:00:00</td>
<td class="text-right">2</td>
<td class="text-left">alloc</td>
<td class="text-left">node[137-138]</td>
</tr>

<tr>
<td class="text-left">s<sub>test</sub></td>
<td class="text-left">up</td>
<td class="text-right">3:00:00</td>
<td class="text-right">1</td>
<td class="text-left">alloc</td>
<td class="text-left">node141</td>
</tr>

<tr>
<td class="text-left">s<sub>standard</sub></td>
<td class="text-left">up</td>
<td class="text-right">8-08:00:00</td>
<td class="text-right">50</td>
<td class="text-left">mix</td>
<td class="text-left">node[146,151,155,157,162-163,167,169,177,183,186,191,196-200,203,219,224-231,233,235,239,241-246,249,255,257,259-260,265-268,297,303,309-310,315]</td>
</tr>

<tr>
<td class="text-left">s<sub>standard</sub></td>
<td class="text-left">up</td>
<td class="text-right">8-08:00:00</td>
<td class="text-right">97</td>
<td class="text-left">alloc</td>
<td class="text-left">node[142-145,147-150,154,156,158-161,164-166,168,170-176,178-182,184-185,187-190,192-195,201-202,204-218,220-223,232,234,236-238,240,247-248,250-254,256,258,261-264,293-296,298-301,304-305,307-308,311-314,316]</td>
</tr>

<tr>
<td class="text-left">s<sub>standard</sub></td>
<td class="text-left">up</td>
<td class="text-right">8-08:00:00</td>
<td class="text-right">4</td>
<td class="text-left">idle</td>
<td class="text-left">node[152-153,302,306]</td>
</tr>

<tr>
<td class="text-left">s<sub>fat</sub></td>
<td class="text-left">up</td>
<td class="text-right">8-08:00:00</td>
<td class="text-right">4</td>
<td class="text-left">alloc</td>
<td class="text-left">node[269-272]</td>
</tr>
</tbody>
</table>

<div class="org-src-container">

<pre class="src src-tmux">srun -p b_standard --time=7-08:00:00 --ntasks-per-node 48 --pty bash
</pre>
</div>

<pre class="example">
server version is too old for client
</pre>


<div class="org-src-container">

<pre class="src src-tmux"><span style="color: #839496; font-weight: bold;">export</span> <span style="color: #268bd2;">MLFLOW_EXPERIMENT_NAME</span>=exp-devtest
<span style="color: #839496; font-weight: bold;">export</span> <span style="color: #268bd2;">MLFLOW_TRACKING_URI</span>=file:./data/mlruns
</pre>
</div>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #859900; font-weight: bold;">setq</span> org-babel-tmux-location <span style="color: #2aa198;">"/usr/local/bin/tmux"</span>)
</pre>
</div>

<pre class="example">
/usr/local/bin/tmux
</pre>



<div class="org-src-container">

<pre class="src src-tmux">module load tools/python/3.7
module load module-git
mlflow --version
git --version
<span style="color: #839496; font-weight: bold;">cd</span> drmed-git
</pre>
</div>

<pre class="example">
[ye53nis@node007 ~]$ mlflow --version
git --version
/cluster/miniconda3/lib/python3.7/site-packages/jinja2/runtime.py:318: DeprecationWarning: Using or importing the ABCs from 'collections' instead of from 'collections.abc' is deprecated since Python 3.3,and
 in 3.9 it will stop working
  from collections import Mapping
mlflow, version 1.7.0
[ye53nis@node007 ~]$ git --version
git version 1.8.3.1
[ye53nis@node007 ~]$
</pre>

<div class="org-src-container">

<pre class="src src-tmux">mlflow run . --no-conda
</pre>
</div>

<pre class="example">
[ye53nis@node007 ~]$ mlflow run . --no-conda
/cluster/miniconda3/lib/python3.7/site-packages/jinja2/runtime.py:318: DeprecationWarning: Using or importing the ABCs from 'collections' instead of from 'collections.abc' is deprecated since Python 3.3,and
 in 3.9 it will stop working
  from collections import Mapping
INFO: 'exp-devtest' does not exist. Creating a new experiment
2020/04/29 13:31:21 ERROR mlflow.cli: === Could not find main among entry points [] or interpret main as a runnable script. Supported script file extensions: ['.py', '.sh'] ===
[ye53nis@node007 ~]$
</pre>

<div class="org-src-container">

<pre class="src src-tmux">mlflow run . -P <span style="color: #268bd2;">fluotracify_path</span>=~/drmed-git/src/ -P <span style="color: #268bd2;">csv_path</span>=/beegfs/ye53nis/saves/firstartifact_Sep2019_subsample/
</pre>
</div>

<pre class="example">
[ye53nis@node007 drmed-git]$ mlflow run . -P fluotracify_path=~/drmed-git/src/ -P csv_path=/beegfs/ye53nis/saves/firstartifact_Sep2019_subsample/
/cluster/miniconda3/lib/python3.7/site-packages/jinja2/runtime.py:318: DeprecationWarning: Using or importing the ABCs from 'collections' instead of from 'collections.abc' is deprecated since Python 3.3,and
 in 3.9 it will stop working
  from collections import Mapping
2020/04/30 17:56:53 INFO mlflow.projects: === Creating conda environment mlflow-1114b06fb561908fc3f52e89d8342d7e52709c81 ===
Collecting package metadata (repodata.json): done
Solving environment: done

Downloading and Extracting Packages
gorilla-0.3.0        | 11 KB     | ################################################################################################################################################################### | 100%
pyasn1-0.4.8         | 58 KB     | ################################################################################################################################################################### | 100%
mako-1.1.2           | 63 KB     | ################################################################################################################################################################### | 100%
flask-1.1.2          | 74 KB     | ################################################################################################################################################################### | 100%
tensorboard-2.1.0    | 3.3 MB    | ################################################################################################################################################################### | 100%
google-auth-1.13.1   | 57 KB     | ################################################################################################################################################################### | 100%
tensorflow-estimator | 251 KB    | ################################################################################################################################################################### | 100%
ncurses-6.2          | 817 KB    | ################################################################################################################################################################### | 100%
intel-openmp-2020.0  | 756 KB    | ################################################################################################################################################################### | 100%
cloudpickle-1.4.0    | 29 KB     | ################################################################################################################################################################### | 100%
mlflow-1.8.0         | 3.2 MB    | ################################################################################################################################################################### | 100%
databricks-cli-0.9.1 | 48 KB     | ################################################################################################################################################################### | 100%
mkl-service-2.3.0    | 218 KB    | ################################################################################################################################################################### | 100%
markupsafe-1.1.1     | 29 KB     | ################################################################################################################################################################### | 100%
libstdcxx-ng-9.1.0   | 3.1 MB    | ################################################################################################################################################################### | 100%
prometheus_client-0. | 42 KB     | ################################################################################################################################################################### | 100%
appdirs-1.4.3        | 15 KB     | ################################################################################################################################################################### | 100%
libprotobuf-3.11.4   | 2.9 MB    | ################################################################################################################################################################### | 100%
protobuf-3.11.4      | 636 KB    | ################################################################################################################################################################### | 100%
tensorflow-2.1.0     | 4 KB      | ################################################################################################################################################################### | 100%
configparser-3.7.4   | 43 KB     | ################################################################################################################################################################### | 100%
opt_einsum-3.1.0     | 54 KB     | ################################################################################################################################################################### | 100%
oauthlib-3.1.0       | 88 KB     | ################################################################################################################################################################### | 100%
python-dateutil-2.8. | 224 KB    | ################################################################################################################################################################### | 100%
werkzeug-1.0.1       | 240 KB    | ################################################################################################################################################################### | 100%
tabulate-0.8.3       | 39 KB     | ################################################################################################################################################################### | 100%
jinja2-2.11.2        | 103 KB    | ################################################################################################################################################################### | 100%
c-ares-1.15.0        | 89 KB     | ################################################################################################################################################################### | 100%
requests-oauthlib-1. | 22 KB     | ################################################################################################################################################################### | 100%
docker-pycreds-0.4.0 | 14 KB     | ################################################################################################################################################################### | 100%
packaging-20.3       | 36 KB     | ################################################################################################################################################################### | 100%
keras-preprocessing- | 36 KB     | ################################################################################################################################################################### | 100%
itsdangerous-1.1.0   | 28 KB     | ################################################################################################################################################################### | 100%
mkl-2020.0           | 128.9 MB  | ################################################################################################################################################################### | 100%
keras-applications-1 | 33 KB     | ################################################################################################################################################################### | 100%
scipy-1.4.1          | 14.5 MB   | ################################################################################################################################################################### | 100%
blinker-1.4          | 22 KB     | ################################################################################################################################################################### | 100%
google-auth-oauthlib | 20 KB     | ################################################################################################################################################################### | 100%
wrapt-1.12.1         | 49 KB     | ################################################################################################################################################################### | 100%
click-7.1.1          | 71 KB     | ################################################################################################################################################################### | 100%
h5py-2.10.0          | 1.0 MB    | ################################################################################################################################################################### | 100%
rsa-4.0              | 29 KB     | ################################################################################################################################################################### | 100%
pyjwt-1.7.1          | 33 KB     | ################################################################################################################################################################### | 100%
pyasn1-modules-0.2.7 | 63 KB     | ################################################################################################################################################################### | 100%
google-pasta-0.2.0   | 44 KB     | ################################################################################################################################################################### | 100%
mkl_fft-1.0.15       | 154 KB    | ################################################################################################################################################################### | 100%
alembic-1.4.2        | 117 KB    | ################################################################################################################################################################### | 100%
backports-1.0        | 139 KB    | ################################################################################################################################################################### | 100%
entrypoints-0.3      | 12 KB     | ################################################################################################################################################################### | 100%
pyyaml-5.3.1         | 181 KB    | ################################################################################################################################################################### | 100%
querystring_parser-1 | 10 KB     | ################################################################################################################################################################### | 100%
prometheus_flask_exp | 15 KB     | ################################################################################################################################################################### | 100%
cachetools-3.1.1     | 14 KB     | ################################################################################################################################################################### | 100%
smmap-3.0.2          | 26 KB     | ################################################################################################################################################################### | 100%
simplejson-3.17.0    | 101 KB    | ################################################################################################################################################################### | 100%
pyparsing-2.4.6      | 64 KB     | ################################################################################################################################################################### | 100%
pytz-2019.3          | 231 KB    | ################################################################################################################################################################### | 100%
sqlalchemy-1.3.13    | 1.4 MB    | ################################################################################################################################################################### | 100%
absl-py-0.9.0        | 167 KB    | ################################################################################################################################################################### | 100%
numpy-base-1.18.1    | 4.2 MB    | ################################################################################################################################################################### | 100%
mkl_random-1.1.0     | 321 KB    | ################################################################################################################################################################### | 100%
python-editor-1.0.4  | 11 KB     | ################################################################################################################################################################### | 100%
gunicorn-20.0.4      | 123 KB    | ################################################################################################################################################################### | 100%
tensorflow-base-2.1. | 95.2 MB   | ################################################################################################################################################################### | 100%
markdown-3.1.1       | 118 KB    | ################################################################################################################################################################### | 100%
astor-0.8.0          | 46 KB     | ################################################################################################################################################################### | 100%
grpcio-1.27.2        | 1.3 MB    | ################################################################################################################################################################### | 100%
sqlparse-0.3.1       | 34 KB     | ################################################################################################################################################################### | 100%
gitdb-4.0.2          | 49 KB     | ################################################################################################################################################################### | 100%
pandas-1.0.3         | 8.6 MB    | ################################################################################################################################################################### | 100%
docker-py-4.2.0      | 188 KB    | ################################################################################################################################################################### | 100%
websocket-client-0.5 | 62 KB     | ################################################################################################################################################################### | 100%
numpy-1.18.1         | 5 KB      | ################################################################################################################################################################### | 100%
gitpython-3.1.1      | 328 KB    | ################################################################################################################################################################### | 100%
Preparing transaction: done
Verifying transaction: done
Executing transaction: done
#
# To activate this environment, use
#
#     $ conda activate mlflow-1114b06fb561908fc3f52e89d8342d7e52709c81
#
# To deactivate an active environment, use
#
#     $ conda deactivate

2020/04/30 18:00:02 INFO mlflow.projects: === Created directory /tmp/tmpbcxyzo3m for downloading remote URIs passed to arguments of type 'path' ===
2020/04/30 18:00:02 INFO mlflow.projects: === Running command 'source activate mlflow-1114b06fb561908fc3f52e89d8342d7e52709c81 1&gt;&amp;2 &amp;&amp; python src/fluotracify/training/train.py /home/ye53nis/drmed-git/src 5
0.2 16384 1e-5 10 /beegfs/ye53nis/saves/firstartifact_Sep2019_subsample' in run with ID '09b669bd51ba4317a6ba4db833a3abb1' ===
/home/ye53nis/.conda/envs/mlflow-1114b06fb561908fc3f52e89d8342d7e52709c81/lib/python3.7/site-packages/tensorflow_core/python/pywrap_tensorflow_internal.py:15: DeprecationWarning: the imp module is deprecate
d in favour of importlib; see the module's documentation for alternative uses
  import imp
2.1.0
/home/ye53nis/drmed-git/src
train 0 /beegfs/ye53nis/saves/firstartifact_Sep2019_subsample/traces_cluster_rand_Sep2019_set003.csv
train 1 /beegfs/ye53nis/saves/firstartifact_Sep2019_subsample/traces_cluster_rand_Sep2019_set002.csv
test 2 /beegfs/ye53nis/saves/firstartifact_Sep2019_subsample/traces_cluster_rand_Sep2019_set001.csv
shapes of feature dataframe: (20000, 200) and label dataframe: (20000, 200)
shapes of feature dataframe: (20000, 100) and label dataframe: (20000, 100)

for each 20,000 timestap trace there are the following numbers of corrupted timesteps:
 label001_1     4124
label002_1     2261
label003_1       45
label004_1    13108
label005_1     2306
dtype: int64
2020-04-30 18:00:19.551555: I tensorflow/core/platform/cpu_feature_guard.cc:142] Your CPU supports instructions that this TensorFlow binary was not compiled to use: SSE4.1 SSE4.2 AVX AVX2 FMA
2020-04-30 18:00:19.563688: I tensorflow/core/platform/profile_utils/cpu_utils.cc:94] CPU Frequency: 2194920000 Hz
2020-04-30 18:00:19.566795: I tensorflow/compiler/xla/service/service.cc:168] XLA service 0x55b0cba23c70 initialized for platform Host (this does not guarantee that XLA will be used). Devices:
2020-04-30 18:00:19.566832: I tensorflow/compiler/xla/service/service.cc:176]   StreamExecutor device (0): Host, Default Version
2020-04-30 18:00:19.567000: I tensorflow/core/common_runtime/process_util.cc:147] Creating new thread pool with default inter op setting: 2. Tune using inter_op_parallelism_threads for best performance.
number of training examples: 160, number of validation examples: 40

------------------------
number of test examples: 100

input - shape:   (None, 16384, 1)
output - shape:  (None, 16384, 1)
/home/ye53nis/.conda/envs/mlflow-1114b06fb561908fc3f52e89d8342d7e52709c81/lib/python3.7/site-packages/tensorflow_core/python/keras/engine/training_utils.py:1389: DeprecationWarning: Using or importing the A
BCs from 'collections' instead of from 'collections.abc' is deprecated since Python 3.3,and in 3.9 it will stop working
  if isinstance(sample_weight_mode, collections.Mapping):
/home/ye53nis/.conda/envs/mlflow-1114b06fb561908fc3f52e89d8342d7e52709c81/lib/python3.7/site-packages/mlflow/utils/autologging_utils.py:60: DeprecationWarning: inspect.getargspec() is deprecated since Pytho
n 3.0, use inspect.signature() or inspect.getfullargspec()
  all_param_names, _, _, all_default_values = inspect.getargspec(fn)  # pylint: disable=W1505
/home/ye53nis/.conda/envs/mlflow-1114b06fb561908fc3f52e89d8342d7e52709c81/lib/python3.7/site-packages/mlflow/utils/autologging_utils.py:70: UserWarning: Logging to MLflow failed: Changing param values is no
t allowed. Param with key='batch_size' was already logged with value='5' for run ID='09b669bd51ba4317a6ba4db833a3abb1'. Attempted logging new value 'None'.
  try_mlflow_log(mlflow.log_params, defaults)
Train for 32.0 steps, validate for 8.0 steps
WARNING:tensorflow:Model failed to serialize as JSON. Ignoring... Layers with arguments in `__init__` must override `get_config`.
Epoch 1/10
2020-04-30 18:00:46.639927: I tensorflow/core/profiler/lib/profiler_session.cc:225] Profiler session started.
32/32 [==============================] - 133s 4s/step - loss: 1.6587 - mean_io_u: 0.4028 - precision: 0.2306 - recall: 0.7511 - val_loss: 1.5574 - val_mean_io_u: 0.3914 - val_precision: 0.1894 - val_recall:
 0.6051
Epoch 2/10
31/32 [============================&gt;.] - ETA: 3s - loss: 1.6133 - mean_io_u: 0.4082 - precision: 0.2488 - recall: 0.7948/home/ye53nis/.conda/envs/mlflow-1114b06fb561908fc3f52e89d8342d7e52709c81/lib/python3.
7/site-packages/mlflow/tensorflow.py:549: UserWarning: Logging to MLflow failed: Got invalid value tf.Tensor(1.6116152, shape=(), dtype=float32) for metric 'val_loss' (timestamp=1588262662579). Please speci
fy value as a valid double (64-bit floating point)
  try_mlflow_log(mlflow.log_metrics, logs, step=epoch)
32/32 [==============================] - 107s 3s/step - loss: 1.6042 - mean_io_u: 0.4055 - precision: 0.2566 - recall: 0.7927 - val_loss: 1.6116 - val_mean_io_u: 0.4122 - val_precision: 0.1641 - val_recall:
 0.8504
Epoch 3/10
32/32 [==============================] - 107s 3s/step - loss: 1.5036 - mean_io_u: 0.3934 - precision: 0.3298 - recall: 0.8165 - val_loss: 1.6282 - val_mean_io_u: 0.4021 - val_precision: 0.1870 - val_recall:
 0.9343
Epoch 4/10
32/32 [==============================] - 105s 3s/step - loss: 1.4783 - mean_io_u: 0.4014 - precision: 0.3343 - recall: 0.8179 - val_loss: 1.6338 - val_mean_io_u: 0.3861 - val_precision: 0.2262 - val_recall:
 0.9908
Epoch 5/10
32/32 [==============================] - 106s 3s/step - loss: 1.4398 - mean_io_u: 0.4006 - precision: 0.3735 - recall: 0.8220 - val_loss: 1.7444 - val_mean_io_u: 0.4101 - val_precision: 0.1798 - val_recall:
 0.9999
Epoch 6/10
32/32 [==============================] - 107s 3s/step - loss: 1.3941 - mean_io_u: 0.3988 - precision: 0.4144 - recall: 0.8005 - val_loss: 1.8832 - val_mean_io_u: 0.4179 - val_precision: 0.1642 - val_recall:
 0.9999
Epoch 7/10
32/32 [==============================] - 107s 3s/step - loss: 1.3660 - mean_io_u: 0.4000 - precision: 0.4544 - recall: 0.8108 - val_loss: 2.0017 - val_mean_io_u: 0.3885 - val_precision: 0.2230 - val_recall:
 0.9999
Epoch 8/10
32/32 [==============================] - 106s 3s/step - loss: 1.3169 - mean_io_u: 0.3993 - precision: 0.5203 - recall: 0.8057 - val_loss: 2.5556 - val_mean_io_u: 0.4147 - val_precision: 0.1706 - val_recall:
 0.9999
Epoch 9/10
32/32 [==============================] - 108s 3s/step - loss: 1.3050 - mean_io_u: 0.4047 - precision: 0.5429 - recall: 0.8009 - val_loss: 3.0439 - val_mean_io_u: 0.3991 - val_precision: 0.2017 - val_recall:
 0.9999
Epoch 10/10
32/32 [==============================] - 107s 3s/step - loss: 1.2911 - mean_io_u: 0.4098 - precision: 0.5691 - recall: 0.7966 - val_loss: 3.6402 - val_mean_io_u: 0.3934 - val_precision: 0.2132 - val_recall:
 1.0000
/home/ye53nis/.conda/envs/mlflow-1114b06fb561908fc3f52e89d8342d7e52709c81/lib/python3.7/site-packages/mlflow/tensorflow.py:552: UserWarning: Logging to MLflow failed: Layers with arguments in `__init__` mus
t override `get_config`.
  try_mlflow_log(mlflow.keras.log_model, self.model, artifact_path='model')
20/20 [==============================] - 17s 843ms/step - loss: 3.5632 - mean_io_u: 0.3849 - precision: 0.2301 - recall: 1.0000
/home/ye53nis/.conda/envs/mlflow-1114b06fb561908fc3f52e89d8342d7e52709c81/lib/python3.7/site-packages/tensorflow_core/python/keras/engine/training_v2_utils.py:544: DeprecationWarning: Using or importing the
 ABCs from 'collections' instead of from 'collections.abc' is deprecated since Python 3.3,and in 3.9 it will stop working
  if isinstance(inputs, collections.Sequence):
2020-04-30 18:19:28.557139: W tensorflow/python/util/util.cc:319] Sets are not currently considered sequences, but this may change in the future, so consider avoiding using them.
WARNING:tensorflow:From /home/ye53nis/.conda/envs/mlflow-1114b06fb561908fc3f52e89d8342d7e52709c81/lib/python3.7/site-packages/tensorflow_core/python/ops/resource_variable_ops.py:1786: calling BaseResourceVa
riable.__init__ (from tensorflow.python.ops.resource_variable_ops) with constraint is deprecated and will be removed in a future version.
Instructions for updating:
If using Keras pass *_constraint arguments to layers.
2020/04/30 18:19:46 INFO mlflow.projects: === Run (ID '09b669bd51ba4317a6ba4db833a3abb1') succeeded ===
[ye53nis@node007 drmed-git]$
</pre>

<p>
Success!!!
</p>
</div>
</li></ol>
</div>
</div>
<div id="outline-container-sec-6-5" class="outline-3">
<h3 id="sec-6-5"><span class="section-number-3">6.5</span> Find solution for large file problem</h3>
<div class="outline-text-3" id="text-6-5">
</div>
<div id="outline-container-sec-6-5-1" class="outline-4">
<h4 id="sec-6-5-1"><span class="section-number-4">6.5.1</span> using <code>git-lfs</code></h4>
<div class="outline-text-4" id="text-6-5-1">
<p>
Problem: the deep network <code>unet.tf</code> is too big (&gt;300MB) and github only allows a
maximum file size of 100MB. Two possible solutions:
</p>
<ul class="org-ul">
<li><b>Git Large File Storage</b>: <a href="https://git-lfs.github.com/">https://git-lfs.github.com/</a> replace large files with text pointers inside
Git. Configured with a <code>.gitattributes</code> file per project. Git commands stay
the same
</li>
<li><b>Git-annex</b>: <a href="https://git-annex.branchable.com/">https://git-annex.branchable.com/</a> own git annex command line
tool. "stupid filename and metadata tracker".
</li>
<li>See <a href="file:///home/lex/Dokumente/org/04_Digital-und-Technik/software-setup.html#MissingReference">here</a> for notes
</li>
</ul>

<p>
NOTE: <b>git commands should not be done on compute node, it's easier on login
node via normal ssh</b>
</p>

<div class="org-src-container">

<pre class="src src-sh">ssh ara
</pre>
</div>

<div class="org-src-container">

<pre class="src src-sh"><span style="color: #839496; font-weight: bold;">pwd</span>
git status
</pre>
</div>

<pre class="example">
/home/ye53nis/drmed-git
# On branch develop
Your branch is ahead of 'origin/develop' by 1 commit.
(use "git push" to publish your local commits)

Untracked files:
(use "git add &lt;file&gt;..." to include in what will be committed)

data/exp-devtest/
nothing added to commit but untracked files present (use "git add" to track)
</pre>

<p>
Encountered problem: git-lfs only syncs files <b>inside</b> the repo. The advised way
to save large files on the HPC is to use the dedicated <code>/beegfs</code> file system,
which is optimised for that stuff. My current repo is in <code>/home</code>
</p>
<ul class="org-ul">
<li>version 1: migrate git repo to beegfs - effectively abandoning <code>/home</code>
</li>
<li>version 2: stay at <code>/home</code> and keep track of <code>/beegfs</code> using tools like
<code>git-annex</code>
</li>
</ul>

<p>
I am trying version 1 now
</p>

<p>
Works!!
</p>

<p>
My <code>-gitattributes</code> file has the following line to track all contents of a
folder which contains ".tf" somewhere in <code>data/</code>
</p>
<pre class="example">
data/**/*.tf/** filter=lfs diff=lfs merge=lfs -text
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-6-6" class="outline-3">
<h3 id="sec-6-6"><span class="section-number-3">6.6</span> run mlflow model as above, but save everything on <code>/beegfs</code></h3>
<div class="outline-text-3" id="text-6-6">
<div class="org-src-container">

<pre class="src src-tmux"><span style="color: #839496; font-weight: bold;">pwd</span>
<span style="color: #839496; font-weight: bold;">cd</span> /beegfs/ye53nis/drmed-git/
<span style="color: #839496; font-weight: bold;">pwd</span>
</pre>
</div>

<pre class="example">
(base) [ye53nis@login01 ~]$ pwd
/home/ye53nis
(base) [ye53nis@login01 ~]$ cd /beegfs/ye53nis/drmed-git/
(base) [ye53nis@login01 drmed-git]$ pwd
/beegfs/ye53nis/drmed-git
(base) [ye53nis@login01 drmed-git]$
</pre>

<div class="org-src-container">

<pre class="src src-tmux">git status
git log -1
</pre>
</div>

<pre class="example">
[ye53nis@node007 drmed-git]$ git status
# On branch develop
nothing to commit, working directory clean
[ye53nis@node007 drmed-git]$ git log -1
commit 9e6182fbeae831a151342827efa59581e4310ae6
Author: Alex Seltmann &lt;seltmann@posteo.de&gt;
Date:   Sat May 2 13:23:42 2020 +0200

    first successful mlflow run without trained net
</pre>

<div class="org-src-container">

<pre class="src src-tmux">mlflow run . -P <span style="color: #268bd2;">fluotracify_path</span>=/beegfs/ye53nis/drmed-git/src/ -P <span style="color: #268bd2;">csv_path</span>=/beegfs/ye53nis/saves/firstartifact_Sep2019_subsample/
</pre>
</div>

<pre class="example">
[ye53nis@node007 drmed-git]$ mlflow run . -P fluotracify_path=/beegfs/ye53nis/drmed-git/src/ -P csv_path=/beegfs/ye53nis/saves/firstartifact_Sep2019_subsample/
/cluster/miniconda3/lib/python3.7/site-packages/jinja2/runtime.py:318: DeprecationWarning: Using or importing the ABCs from 'collections' instead of from 'collections.abc' is deprecated since Python 3.3,and
 in 3.9 it will stop working
  from collections import Mapping
WARNING:root:Malformed experiment '1'. Detailed error Yaml file './data/mlruns/1/meta.yaml' does not exist.
Traceback (most recent call last):
  File "/cluster/miniconda3/lib/python3.7/site-packages/mlflow/store/tracking/file_store.py", line 197, in list_experiments
    experiment = self._get_experiment(exp_id, view_type)
  File "/cluster/miniconda3/lib/python3.7/site-packages/mlflow/store/tracking/file_store.py", line 256, in _get_experiment
    meta = read_yaml(experiment_dir, FileStore.META_DATA_FILE_NAME)
  File "/cluster/miniconda3/lib/python3.7/site-packages/mlflow/utils/file_utils.py", line 160, in read_yaml
    raise MissingConfigException("Yaml file '%s' does not exist." % file_path)
mlflow.exceptions.MissingConfigException: Yaml file './data/mlruns/1/meta.yaml' does not exist.
INFO: 'exp-devtest' does not exist. Creating a new experiment
WARNING:root:Malformed experiment '1'. Detailed error Yaml file './data/mlruns/1/meta.yaml' does not exist.
Traceback (most recent call last):
  File "/cluster/miniconda3/lib/python3.7/site-packages/mlflow/store/tracking/file_store.py", line 197, in list_experiments
    experiment = self._get_experiment(exp_id, view_type)
  File "/cluster/miniconda3/lib/python3.7/site-packages/mlflow/store/tracking/file_store.py", line 256, in _get_experiment
    meta = read_yaml(experiment_dir, FileStore.META_DATA_FILE_NAME)
  File "/cluster/miniconda3/lib/python3.7/site-packages/mlflow/utils/file_utils.py", line 160, in read_yaml
    raise MissingConfigException("Yaml file '%s' does not exist." % file_path)
mlflow.exceptions.MissingConfigException: Yaml file './data/mlruns/1/meta.yaml' does not exist.
WARNING:root:Malformed experiment '1'. Detailed error Yaml file './data/mlruns/1/meta.yaml' does not exist.
Traceback (most recent call last):
  File "/cluster/miniconda3/lib/python3.7/site-packages/mlflow/store/tracking/file_store.py", line 197, in list_experiments
    experiment = self._get_experiment(exp_id, view_type)
  File "/cluster/miniconda3/lib/python3.7/site-packages/mlflow/store/tracking/file_store.py", line 256, in _get_experiment
    meta = read_yaml(experiment_dir, FileStore.META_DATA_FILE_NAME)
  File "/cluster/miniconda3/lib/python3.7/site-packages/mlflow/utils/file_utils.py", line 160, in read_yaml
    raise MissingConfigException("Yaml file '%s' does not exist." % file_path)
mlflow.exceptions.MissingConfigException: Yaml file './data/mlruns/1/meta.yaml' does not exist.
2020/05/02 14:47:02 INFO mlflow.projects: === Created directory /tmp/tmp7uyf926z for downloading remote URIs passed to arguments of type 'path' ===
2020/05/02 14:47:02 INFO mlflow.projects: === Running command 'source activate mlflow-1114b06fb561908fc3f52e89d8342d7e52709c81 1&gt;&amp;2 &amp;&amp; python src/fluotracify/training/train.py /beegfs/ye53nis/drmed-git/src
5 0.2 16384 1e-5 10 /beegfs/ye53nis/saves/firstartifact_Sep2019_subsample' in run with ID 'cda4eec66a6947c38ec2ee2006563ae5' ===
/home/ye53nis/.conda/envs/mlflow-1114b06fb561908fc3f52e89d8342d7e52709c81/lib/python3.7/site-packages/tensorflow_core/python/pywrap_tensorflow_internal.py:15: DeprecationWarning: the imp module is deprecate
d in favour of importlib; see the module's documentation for alternative uses
  import imp
^[[B^[[B^[[B^[[B^[[B^[[B2.1.0
/beegfs/ye53nis/drmed-git/src
train 0 /beegfs/ye53nis/saves/firstartifact_Sep2019_subsample/traces_cluster_rand_Sep2019_set003.csv
train 1 /beegfs/ye53nis/saves/firstartifact_Sep2019_subsample/traces_cluster_rand_Sep2019_set002.csv
test 2 /beegfs/ye53nis/saves/firstartifact_Sep2019_subsample/traces_cluster_rand_Sep2019_set001.csv
shapes of feature dataframe: (20000, 200) and label dataframe: (20000, 200)
shapes of feature dataframe: (20000, 100) and label dataframe: (20000, 100)

for each 20,000 timestap trace there are the following numbers of corrupted timesteps:
 label001_1     4124
label002_1     2261
label003_1       45
label004_1    13108
label005_1     2306
dtype: int64
2020-05-02 14:48:01.189272: I tensorflow/core/platform/cpu_feature_guard.cc:142] Your CPU supports instructions that this TensorFlow binary was not compiled to use: SSE4.1 SSE4.2 AVX AVX2 FMA
2020-05-02 14:48:01.222648: I tensorflow/core/platform/profile_utils/cpu_utils.cc:94] CPU Frequency: 2194920000 Hz
2020-05-02 14:48:01.226156: I tensorflow/compiler/xla/service/service.cc:168] XLA service 0x563a41791e20 initialized for platform Host (this does not guarantee that XLA will be used). Devices:
2020-05-02 14:48:01.226237: I tensorflow/compiler/xla/service/service.cc:176]   StreamExecutor device (0): Host, Default Version
2020-05-02 14:48:01.226502: I tensorflow/core/common_runtime/process_util.cc:147] Creating new thread pool with default inter op setting: 2. Tune using inter_op_parallelism_threads for best performance.
number of training examples: 160, number of validation examples: 40

------------------------
number of test examples: 100

input - shape:   (None, 16384, 1)
output - shape:  (None, 16384, 1)
/home/ye53nis/.conda/envs/mlflow-1114b06fb561908fc3f52e89d8342d7e52709c81/lib/python3.7/site-packages/tensorflow_core/python/keras/engine/training_utils.py:1389: DeprecationWarning: Using or importing the A
BCs from 'collections' instead of from 'collections.abc' is deprecated since Python 3.3,and in 3.9 it will stop working
  if isinstance(sample_weight_mode, collections.Mapping):
/home/ye53nis/.conda/envs/mlflow-1114b06fb561908fc3f52e89d8342d7e52709c81/lib/python3.7/site-packages/mlflow/utils/autologging_utils.py:60: DeprecationWarning: inspect.getargspec() is deprecated since Pytho
n 3.0, use inspect.signature() or inspect.getfullargspec()
  all_param_names, _, _, all_default_values = inspect.getargspec(fn)  # pylint: disable=W1505
/home/ye53nis/.conda/envs/mlflow-1114b06fb561908fc3f52e89d8342d7e52709c81/lib/python3.7/site-packages/mlflow/utils/autologging_utils.py:70: UserWarning: Logging to MLflow failed: Changing param values is no
t allowed. Param with key='batch_size' was already logged with value='5' for run ID='cda4eec66a6947c38ec2ee2006563ae5'. Attempted logging new value 'None'.
  try_mlflow_log(mlflow.log_params, defaults)
Train for 32.0 steps, validate for 8.0 steps
WARNING:tensorflow:Model failed to serialize as JSON. Ignoring... Layers with arguments in `__init__` must override `get_config`.
Epoch 1/10
2020-05-02 14:48:28.731100: I tensorflow/core/profiler/lib/profiler_session.cc:225] Profiler session started.
32/32 [==============================] - 133s 4s/step - loss: 1.6869 - mean_io_u: 0.4035 - precision: 0.1949 - recall: 0.6740 - val_loss: 1.5778 - val_mean_io_u: 0.4210 - val_precision: 0.1500 - val_recall:
 5.7965e-05
Epoch 2/10
31/32 [============================&gt;.] - ETA: 3s - loss: 1.5936 - mean_io_u: 0.4047 - precision: 0.2461 - recall: 0.7594/home/ye53nis/.conda/envs/mlflow-1114b06fb561908fc3f52e89d8342d7e52709c81/lib/python3.
7/site-packages/mlflow/tensorflow.py:549: UserWarning: Logging to MLflow failed: Got invalid value tf.Tensor(1.5411952, shape=(), dtype=float32) for metric 'val_loss' (timestamp=1588423924159). Please speci
fy value as a valid double (64-bit floating point)
  try_mlflow_log(mlflow.log_metrics, logs, step=epoch)
32/32 [==============================] - 106s 3s/step - loss: 1.5935 - mean_io_u: 0.4051 - precision: 0.2456 - recall: 0.7601 - val_loss: 1.5412 - val_mean_io_u: 0.3977 - val_precision: 0.3000 - val_recall:
 8.9508e-05
Epoch 3/10
32/32 [==============================] - 108s 3s/step - loss: 1.5357 - mean_io_u: 0.4039 - precision: 0.2901 - recall: 0.8025 - val_loss: 1.5201 - val_mean_io_u: 0.3834 - val_precision: 0.2500 - val_recall:
 6.5409e-05
Epoch 4/10
32/32 [==============================] - 109s 3s/step - loss: 1.4929 - mean_io_u: 0.4041 - precision: 0.3227 - recall: 0.8099 - val_loss: 1.5400 - val_mean_io_u: 0.3990 - val_precision: 0.2011 - val_recall:
 0.0535
Epoch 5/10
32/32 [==============================] - 108s 3s/step - loss: 1.4589 - mean_io_u: 0.4054 - precision: 0.3445 - recall: 0.7970 - val_loss: 1.5471 - val_mean_io_u: 0.3927 - val_precision: 0.2178 - val_recall:
 0.3854
Epoch 6/10
32/32 [==============================] - 108s 3s/step - loss: 1.4293 - mean_io_u: 0.4059 - precision: 0.3692 - recall: 0.7784 - val_loss: 1.6078 - val_mean_io_u: 0.4057 - val_precision: 0.1891 - val_recall:
 0.9730
Epoch 7/10
32/32 [==============================] - 108s 3s/step - loss: 1.3821 - mean_io_u: 0.4005 - precision: 0.4276 - recall: 0.7645 - val_loss: 1.7784 - val_mean_io_u: 0.4182 - val_precision: 0.1636 - val_recall:
 0.9998
Epoch 8/10
32/32 [==============================] - 109s 3s/step - loss: 1.3219 - mean_io_u: 0.3993 - precision: 0.5042 - recall: 0.8182 - val_loss: 1.9800 - val_mean_io_u: 0.3925 - val_precision: 0.2150 - val_recall:
 0.9999
Epoch 9/10
32/32 [==============================] - 107s 3s/step - loss: 1.2852 - mean_io_u: 0.3930 - precision: 0.5602 - recall: 0.7957 - val_loss: 2.5127 - val_mean_io_u: 0.4206 - val_precision: 0.1587 - val_recall:
 1.0000
Epoch 10/10
32/32 [==============================] - 108s 3s/step - loss: 1.2926 - mean_io_u: 0.4057 - precision: 0.5469 - recall: 0.8147 - val_loss: 2.9090 - val_mean_io_u: 0.3916 - val_precision: 0.2169 - val_recall:
 1.0000
/home/ye53nis/.conda/envs/mlflow-1114b06fb561908fc3f52e89d8342d7e52709c81/lib/python3.7/site-packages/mlflow/tensorflow.py:552: UserWarning: Logging to MLflow failed: Layers with arguments in `__init__` mus
t override `get_config`.
  try_mlflow_log(mlflow.keras.log_model, self.model, artifact_path='model')
20/20 [==============================] - 17s 865ms/step - loss: 2.9045 - mean_io_u: 0.3849 - precision: 0.2301 - recall: 1.0000
/home/ye53nis/.conda/envs/mlflow-1114b06fb561908fc3f52e89d8342d7e52709c81/lib/python3.7/site-packages/tensorflow_core/python/keras/engine/training_v2_utils.py:544: DeprecationWarning: Using or importing the
 ABCs from 'collections' instead of from 'collections.abc' is deprecated since Python 3.3,and in 3.9 it will stop working
  if isinstance(inputs, collections.Sequence):
2020-05-02 15:07:19.835685: W tensorflow/python/util/util.cc:319] Sets are not currently considered sequences, but this may change in the future, so consider avoiding using them.
WARNING:tensorflow:From /home/ye53nis/.conda/envs/mlflow-1114b06fb561908fc3f52e89d8342d7e52709c81/lib/python3.7/site-packages/tensorflow_core/python/ops/resource_variable_ops.py:1786: calling BaseResourceVa
riable.__init__ (from tensorflow.python.ops.resource_variable_ops) with constraint is deprecated and will be removed in a future version.
Instructions for updating:
If using Keras pass *_constraint arguments to layers.
2020/05/02 15:07:38 INFO mlflow.projects: === Run (ID 'cda4eec66a6947c38ec2ee2006563ae5') succeeded ===
[ye53nis@node007 drmed-git]$
</pre>

<p>
Comparison to run at <code>/home</code>:
</p>
<ul class="org-ul">
<li>some "misformed experiment" warning. Probably bc I tried to rebase the repo on
the remote, because I committed the big <code>unet.tf</code> folder and wanted to redo
that (it seemed that failed and my first test run got lost)
</li>
<li>same conda env got loaded, and the run seems to have conducted without
problems, jippieh!
</li>
</ul>
</div>

<div id="outline-container-sec-6-6-1" class="outline-4">
<h4 id="sec-6-6-1"><span class="section-number-4">6.6.1</span> checking out mlflow error messages <code>[0/5]</code></h4>
<div class="outline-text-4" id="text-6-6-1">
</div>

<ol class="org-ol"><li><a id="sec-6-6-1-1" name="sec-6-6-1-1"></a><span class="label label-primary TODO">TODO</span> 1. tensorflow: your CPU supports instructions that this TF binary was not compiled to use<br ><div class="outline-text-5" id="text-6-6-1-1">
<pre class="example">
2020-05-02 14:48:01.189272: I tensorflow/core/platform/cpu_feature_guard.cc:142]
  Your CPU supports instructions that this TensorFlow binary was not
  compiled to use: SSE4.1 SSE4.2 AVX AVX2 FMA
2020-05-02 14:48:01.222648: I tensorflow/core/platform/profile_utils/cpu_utils.cc:94]
  CPU Frequency: 2194920000 Hz
2020-05-02 14:48:01.226156: I tensorflow/compiler/xla/service/service.cc:168]
  XLA service 0x563a41791e20 initialized for platform Host (this does not
  guarantee that XLA will be used). Devices:
2020-05-02 14:48:01.226237: I tensorflow/compiler/xla/service/service.cc:176]
  StreamExecutor device (0): Host, Default Version
2020-05-02 14:48:01.226502: I tensorflow/core/common_runtime/process_util.cc:147]
  Creating new thread pool with default inter op setting: 2.
  Tune using inter_op_parallelism_threads for best performance.

2020-05-02 15:07:19.835685: W tensorflow/python/util/util.cc:319]
  Sets are not currently considered sequences, but this may change in the future,
  so consider avoiding using them.
</pre>

<p>
See <a href="https://github.com/tensorflow/tensorflow/issues/34369">this Github issue</a>: the second part of the error is related to the first one,
and thus can be ignored (or solved following one of the paths below)
</p>

<p>
See <a href="https://stackoverflow.com/questions/47068709/your-cpu-supports-instructions-that-this-tensorflow-binary-was-not-compiled-to-u">here</a>: It's only an issue if you run the code on a CPU!
</p>

<p>
The mentioned SSE, AVX, FMA etc are extensions from Intel and AMD to
speed up linear algebra computation, e.g. dot-product, matrix multiply,
convolution, etc. AVX and FMA speed them up on a CPU up to 300%. The warning
states that the CPU does support them, but <code>tensorflow</code> does not with the
default installation.
</p>

<p>
If you have a GPU:
</p>
<ul class="org-ul">
<li>don't care about AVX etc support, because running on a GPU is way better
</li>
<li>you can ignore this warning by:
<div class="org-src-container">

<pre class="src src-python"><span style="color: #586e75;"># </span><span style="color: #586e75;">Just disables the warning, doesn't enable AVX/FMA</span>
<span style="color: #859900; font-weight: bold;">import</span> os
<span style="color: #839496; background-color: #002b36;">os.environ</span>[<span style="color: #2aa198;">'TF_CPP_MIN_LOG_LEVEL'</span>] = <span style="color: #2aa198;">'2'</span>
</pre>
</div>
<p>
or
</p>
<div class="org-src-container">

<pre class="src src-sh"><span style="color: #839496; font-weight: bold;">export</span> <span style="color: #268bd2;">TF_CPP_MIN_LOG_LEVEL</span>=2
</pre>
</div>
</li>
</ul>

<p>
If you don't have a GPU / don't want to use it:
</p>
<ul class="org-ul">
<li>default tensorflow is intended to be compatible with as many CPUs as possible,
that's why these libraries are note preinstalled
</li>
<li><b>build tensorflow from the source optimized for <i>your</i> CPU</b> - that's quite
some additional work&#x2026; if I should do this, here is TF <a href="https://www.tensorflow.org/install/source">guide</a>
</li>
</ul>
</div>
<ol class="org-ol"><li><a id="sec-6-6-1-1-1" name="sec-6-6-1-1-1"></a><span class="label label-primary TODO">TODO</span> Run this code on a GPU node, then decide. Maybe use docker to easily use TF on the nodes<br ></li></ol>
</li>
<li><a id="sec-6-6-1-2" name="sec-6-6-1-2"></a><span class="label label-primary TODO">TODO</span> 2. mlflow: ABCs from 'collections'<br ><div class="outline-text-5" id="text-6-6-1-2">
<pre class="example">
/home/ye53nis/.conda/envs/mlflow-1114b06fb561908fc3f52e89d8342d7e52709c81/lib/python3.7/site-packages/tensorflow_core/python/keras/engine/training_utils.py:1389:
  DeprecationWarning: Using or importing the ABCs from 'collections' instead of from
  'collections.abc' is deprecated since Python 3.3,and in 3.9 it will stop working
  if isinstance(sample_weight_mode, collections.Mapping):
/home/ye53nis/.conda/envs/mlflow-1114b06fb561908fc3f52e89d8342d7e52709c81/lib/python3.7/site-packages/mlflow/utils/autologging_utils.py:60:
  DeprecationWarning: inspect.getargspec() is deprecated since Python 3.0,
  use inspect.signature() or inspect.getfullargspec()
</pre>

<p>
I suspect these will be solved with an <code>mlflow</code> update.
</p>
</div>
</li>

<li><a id="sec-6-6-1-3" name="sec-6-6-1-3"></a><span class="label label-primary PENDING">PENDING</span> 3. calling BaseResourceVariable._<sub>init</sub>__<br ><div class="outline-text-5" id="text-6-6-1-3">
<ul class="org-ul">
<li>State "PENDING"    from "TODO"       <span class="timestamp-wrapper"><span class="timestamp">[2020-05-05 Di 15:01] </span></span> <br >
Wait till this commit
<a href="https://github.com/tensorflow/tensorflow/commit/1e2c8c6873770a70ace0613a65c11826666c4623#diff-aa6c341a4b212afc57b49be73e689dc2">https://github.com/tensorflow/tensorflow/commit/1e2c8c6873770a70ace0613a65c11826666c4623#diff-aa6c341a4b212afc57b49be73e689dc2</a>
which introduces Conv1DTranspose officially is released. If it takes too long:
install tf-nightly, but this might be unstable.
</li>
</ul>
<pre class="example">
WARNING:tensorflow:From /home/ye53nis/.conda/envs/mlflow-1114b06fb561908fc3f52e89d8342d7e52709c81/lib/python3.7/site-packages/tensorflow_core/python/ops/resource_variable_ops.py:1786:
  calling BaseResourceVariable.__init__ (from tensorflow.python.ops.resource_variable_ops)
  with constraint is deprecated and will be removed in a future version.
  Instructions for updating:
  If using Keras pass *_constraint arguments to layers.
WARNING:tensorflow:Model failed to serialize as JSON.
  Ignoring... Layers with arguments in `__init__` must override `get_config`.

/home/ye53nis/.conda/envs/mlflow-1114b06fb561908fc3f52e89d8342d7e52709c81/lib/python3.7/site-packages/mlflow/tensorflow.py:552:
  UserWarning: Logging to MLflow failed: Layers with arguments in `__init__` must override `get_config`.
  try_mlflow_log(mlflow.keras.log_model, self.model, artifact_path='model')
</pre>

<p>
The <code>BaseResourceVariable</code> one seems to be connected to keras' SavedModel
 format and happens in the <a href="https://www.tensorflow.org/tutorials/keras/save_and_load">official TF keras tutorial</a> when using
<code>model.save('saved_model/my_model')</code>.
</p>

<p>
I am still not settled on how to save models anyway. I think I will use
<a href="https://mlflow.org/docs/latest/python_api/mlflow.tensorflow.html#mlflow.tensorflow.save_model">mlflow.tensorflow.save<sub>model</sub>()</a> or <code>mlflow.tensorflow.log_model</code> (not sure what
the difference is). BUT this needs a <i>serialized</i> collection of TF graphs and
variables. Maybe I have to do some more work, see below&#x2026;
</p>

<p>
from <a href="https://www.tensorflow.org/guide/keras/save_and_serialize">TF keras guide</a>:
</p>
<ul class="org-ul">
<li>Saving the architecture (= layers and how these layers are connected)  model
can be created with freshly initialized state for weights and no compilation
info
<ul class="org-ul">
<li>Sequential model / functional API model: are explicit graphs of layers,
config always available in a structured form.
<ul class="org-ul">
<li><code>layer.get_config()</code> or <code>model.get_config()</code> will return Python dict
containing the config of the model
</li>
<li>Model can be reconstructed
<ul class="org-ul">
<li>Sequential model: <code>Sequential.from_config(config)</code>
</li>
<li>Functional API model: <code>Model.from_config(config)</code>
</li>
</ul>
</li>
</ul>
</li>
<li>Custom objects
<ul class="org-ul">
<li>Models and layers: In order to save/load a model with custom-defined
layers, or a subclassed model, you should overwrite the <code>get_config</code> and
optionally <code>from_config</code> methods. Additionally, you should use register
the custom object so that Keras is aware of it.
</li>
<li>Custom functions (e.g. activation loss&#x2026;) do not need <code>get_config</code>,
function name is sufficient for loading as long as it is registered as a
custom object
</li>
<li>defining <code>Get_config</code>: should return a JSON-serializable dict in order to
be compatible with Keras architecture- and model-saving APIs
</li>
<li>defining <code>from_config(config)</code>: should return a new layer or model object
that is created from the config. Default implementation returns
<code>cls(**config)</code>
</li>
</ul>
</li>
</ul>
</li>
</ul>

<p>
See <a href="https://stackoverflow.com/questions/58678836/notimplementederror-layers-with-arguments-in-init-must-override-get-conf">this SO question</a>:
</p>
<ul class="org-ul">
<li>an example for a class which makes <code>model.save</code> fail:
<div class="org-src-container">

<pre class="src src-python"><span style="color: #859900; font-weight: bold;">class</span> <span style="color: #b58900;">encoder</span>(tf.keras.layers.Layer):

<span style="background-color: #073642;"> </span>   <span style="color: #859900; font-weight: bold;">def</span> <span style="color: #268bd2;">__init__</span>(
<span style="background-color: #073642;"> </span>   <span style="background-color: #073642;"> </span>   <span style="color: #859900; font-weight: bold;">self</span>,
<span style="background-color: #073642;"> </span>   <span style="background-color: #073642;"> </span>   vocab_size, num_layers, units, d_model, num_heads, dropout,
<span style="background-color: #073642;"> </span>   <span style="background-color: #073642;"> </span>   **kwargs,
<span style="background-color: #073642;"> </span>   ):
<span style="background-color: #073642;"> </span>   <span style="background-color: #073642;"> </span>   <span style="color: #839496; font-weight: bold;">super</span>().__init__(**kwargs)
<span style="background-color: #073642;"> </span>   <span style="background-color: #073642;"> </span>   <span style="color: #859900; font-weight: bold;">self</span>.vocab_size = vocab_size
<span style="background-color: #073642;"> </span>   <span style="background-color: #073642;"> </span>   <span style="color: #859900; font-weight: bold;">self</span>.num_layers = num_layers
<span style="background-color: #073642;"> </span>   <span style="background-color: #073642;"> </span>   <span style="color: #859900; font-weight: bold;">self</span>.units = units
<span style="background-color: #073642;"> </span>   <span style="background-color: #073642;"> </span>   <span style="color: #859900; font-weight: bold;">self</span>.d_model = d_model
<span style="background-color: #073642;"> </span>   <span style="background-color: #073642;"> </span>   <span style="color: #859900; font-weight: bold;">self</span>.num_heads = num_heads
<span style="background-color: #073642;"> </span>   <span style="background-color: #073642;"> </span>   <span style="color: #859900; font-weight: bold;">self</span>.dropout = dropout

<span style="background-color: #073642;"> </span>   <span style="color: #586e75;"># </span><span style="color: #586e75;">Other methods etc.</span>
</pre>
</div>
</li>
<li>and now you need to override this method:
<div class="org-src-container">

<pre class="src src-python"><span style="color: #859900; font-weight: bold;">def</span> <span style="color: #268bd2;">get_config</span>(<span style="color: #859900; font-weight: bold;">self</span>):

<span style="background-color: #073642;"> </span>   <span style="color: #839496; background-color: #002b36;">config</span> = <span style="color: #839496; font-weight: bold;">super</span>().get_config().copy()
<span style="background-color: #073642;"> </span>   config.update({
<span style="background-color: #073642;"> </span>   <span style="background-color: #073642;"> </span>   <span style="color: #2aa198;">'vocab_size'</span>: <span style="color: #859900; font-weight: bold;">self</span>.vocab_size,
<span style="background-color: #073642;"> </span>   <span style="background-color: #073642;"> </span>   <span style="color: #2aa198;">'num_layers'</span>: <span style="color: #859900; font-weight: bold;">self</span>.num_layers,
<span style="background-color: #073642;"> </span>   <span style="background-color: #073642;"> </span>   <span style="color: #2aa198;">'units'</span>: <span style="color: #859900; font-weight: bold;">self</span>.units,
<span style="background-color: #073642;"> </span>   <span style="background-color: #073642;"> </span>   <span style="color: #2aa198;">'d_model'</span>: <span style="color: #859900; font-weight: bold;">self</span>.d_model,
<span style="background-color: #073642;"> </span>   <span style="background-color: #073642;"> </span>   <span style="color: #2aa198;">'num_heads'</span>: <span style="color: #859900; font-weight: bold;">self</span>.num_heads,
<span style="background-color: #073642;"> </span>   <span style="background-color: #073642;"> </span>   <span style="color: #2aa198;">'dropout'</span>: <span style="color: #859900; font-weight: bold;">self</span>.dropout,
<span style="background-color: #073642;"> </span>   })
<span style="background-color: #073642;"> </span>   <span style="color: #859900; font-weight: bold;">return</span> config
</pre>
</div>
</li>
<li>and for <code>layer.from_config</code>:
<div class="org-src-container">

<pre class="src src-python"><span style="color: #859900; font-weight: bold;">@classmethod</span>
<span style="color: #859900; font-weight: bold;">def</span> <span style="color: #268bd2;">from_config</span>(<span style="color: #859900; font-weight: bold;">cls</span>, config):
<span style="background-color: #073642;"> </span>   <span style="color: #859900; font-weight: bold;">return</span> <span style="color: #859900; font-weight: bold;">cls</span>(**config)
</pre>
</div>
</li>
</ul>
</div>
</li>
<li><a id="sec-6-6-1-4" name="sec-6-6-1-4"></a><span class="label label-primary PENDING">PENDING</span> 4. Logging to MLflow failed: Changing param values is not allowed<br ><div class="outline-text-5" id="text-6-6-1-4">
<ul class="org-ul">
<li>State "PENDING"    from "TODO"       <span class="timestamp-wrapper"><span class="timestamp">[2020-05-05 Di 13:46] </span></span> <br >
Renamed batch<sub>size</sub> to _batch<sub>size</sub> to emphasize the local character. let's see if
the error still occurs
</li>
</ul>

<pre class="example">
/home/ye53nis/.conda/envs/mlflow-1114b06fb561908fc3f52e89d8342d7e52709c81/lib/python3.7/site-packages/mlflow/utils/autologging_utils.py:70:
  UserWarning: Logging to MLflow failed:
  Changing param values is not allowed.
  Param with key='batch_size' was already logged with value='5' for run ID='cda4eec66a6947c38ec2ee2006563ae5'.
  Attempted logging new value 'None'.
try_mlflow_log(mlflow.log_params, defaults)
</pre>

<p>
Couldn't find anything googling that. Probably has something to do with naming
the variable <code>batch_size</code>, which may be a variable the autologging feature
already uses?
</p>
</div>
</li>

<li><a id="sec-6-6-1-5" name="sec-6-6-1-5"></a><span class="label label-primary PENDING">PENDING</span> 5. invalid value tf.Tensor(&#x2026;, dtype=float32). Please specify value as a valid double<br ><div class="outline-text-5" id="text-6-6-1-5">
<ul class="org-ul">
<li>State "TODO"       from "PENDING"    <span class="timestamp-wrapper"><span class="timestamp">[2020-05-05 Di 15:26]</span></span>
</li>
<li>State "PENDING"    from "TODO"       <span class="timestamp-wrapper"><span class="timestamp">[2020-05-05 Di 13:53] </span></span> <br >
I added tf.keras.backend.set<sub>floatx</sub>('float64')
</li>
</ul>
<pre class="example">
/home/ye53nis/.conda/envs/mlflow-1114b06fb561908fc3f52e89d8342d7e52709c81/lib/python3.7/site-packages/mlflow/tensorflow.py:549:
  UserWarning: Logging to MLflow failed:
  Got invalid value tf.Tensor(1.5411952, shape=(), dtype=float32) for metric 'val_loss'
  (timestamp=1588423924159). Please specify value as a valid double (64-bit floating point)
try_mlflow_log(mlflow.log_metrics, logs, step=epoch)
</pre>

<p>
Check out if val<sub>loss</sub> got logged in the end.  doesn't seem so. It can be found
under <code>artifacts/tensorboard_logs</code> and these are not text files, but some binary
files.
</p>

<p>
In theory, validation loss and training loss should be logged by mlflow as well
(and custom metrics as well)  check that they are a valid 64-bit integer value.
</p>
</div>
</li>

<li><a id="sec-6-6-1-6" name="sec-6-6-1-6"></a>Test run fixing 4. and 5.<br ><div class="outline-text-5" id="text-6-6-1-6">
<div class="org-src-container">

<pre class="src src-tmux"><span style="color: #839496; font-weight: bold;">pwd</span>
git log -1
</pre>
</div>

<pre class="example">
[ye53nis@node007 drmed-git]$ pwd
/beegfs/ye53nis/drmed-git
[ye53nis@node007 drmed-git]$ git log -1
commit e9983783a946d57f95b3a28405c5a2d74108f6b9
Author: Apoplex &lt;oligolex@vivaldi.net&gt;
Date:   Tue May 5 15:07:02 2020 +0200

    Set tf.keras standard to float64; rename var
[ye53nis@node007 drmed-git]$
</pre>

<div class="org-src-container">

<pre class="src src-tmux">mlflow run . -P <span style="color: #268bd2;">fluotracify_path</span>=/beegfs/ye53nis/drmed-git/src/ -P <span style="color: #268bd2;">csv_path</span>=/beegfs/ye53nis/saves/firstartifact_Sep2019_subsample/
</pre>
</div>

<pre class="example">

------------------------
number of test examples: 100

input - shape:   (None, 16384, 1)
output - shape:  (None, 16384, 1)
Traceback (most recent call last):
  File "src/fluotracify/training/train.py", line 79, in &lt;module&gt;
    tf.keras.metrics.Recall()
  File "/home/ye53nis/.conda/envs/mlflow-1114b06fb561908fc3f52e89d8342d7e52709c81/lib/python3.7/site-packages/tensorflow_core/python/training/tracking/base.py", line 457, in _method_wrapper
    result = method(self, *args, **kwargs)
  File "/home/ye53nis/.conda/envs/mlflow-1114b06fb561908fc3f52e89d8342d7e52709c81/lib/python3.7/site-packages/tensorflow_core/python/keras/engine/training.py", line 439, in compile
    masks=self._prepare_output_masks())
  File "/home/ye53nis/.conda/envs/mlflow-1114b06fb561908fc3f52e89d8342d7e52709c81/lib/python3.7/site-packages/tensorflow_core/python/keras/engine/training.py", line 2004, in _handle_metrics
    target, output, output_mask))
  File "/home/ye53nis/.conda/envs/mlflow-1114b06fb561908fc3f52e89d8342d7e52709c81/lib/python3.7/site-packages/tensorflow_core/python/keras/engine/training.py", line 1955, in _handle_per_output_metrics
    metric_fn, y_true, y_pred, weights=weights, mask=mask)
  File "/home/ye53nis/.conda/envs/mlflow-1114b06fb561908fc3f52e89d8342d7e52709c81/lib/python3.7/site-packages/tensorflow_core/python/keras/engine/training_utils.py", line 1155, in call_metric_function
    return metric_fn(y_true, y_pred, sample_weight=weights)
  File "/home/ye53nis/.conda/envs/mlflow-1114b06fb561908fc3f52e89d8342d7e52709c81/lib/python3.7/site-packages/tensorflow_core/python/keras/metrics.py", line 196, in __call__
    replica_local_fn, *args, **kwargs)
  File "/home/ye53nis/.conda/envs/mlflow-1114b06fb561908fc3f52e89d8342d7e52709c81/lib/python3.7/site-packages/tensorflow_core/python/keras/distribute/distributed_training_utils.py", line 1135, in call_repli
ca_local_fn
    return fn(*args, **kwargs)
  File "/home/ye53nis/.conda/envs/mlflow-1114b06fb561908fc3f52e89d8342d7e52709c81/lib/python3.7/site-packages/tensorflow_core/python/keras/metrics.py", line 179, in replica_local_fn
    update_op = self.update_state(*args, **kwargs)  # pylint: disable=not-callable
  File "/home/ye53nis/.conda/envs/mlflow-1114b06fb561908fc3f52e89d8342d7e52709c81/lib/python3.7/site-packages/tensorflow_core/python/keras/utils/metrics_utils.py", line 76, in decorated
    update_op = update_state_fn(*args, **kwargs)
  File "/home/ye53nis/.conda/envs/mlflow-1114b06fb561908fc3f52e89d8342d7e52709c81/lib/python3.7/site-packages/tensorflow_core/python/keras/metrics.py", line 1216, in update_state
    sample_weight=sample_weight)
  File "/home/ye53nis/.conda/envs/mlflow-1114b06fb561908fc3f52e89d8342d7e52709c81/lib/python3.7/site-packages/tensorflow_core/python/keras/utils/metrics_utils.py", line 440, in update_confusion_matrix_varia
bles
    variables_to_update[matrix_cond]))
  File "/home/ye53nis/.conda/envs/mlflow-1114b06fb561908fc3f52e89d8342d7e52709c81/lib/python3.7/site-packages/tensorflow_core/python/keras/utils/metrics_utils.py", line 416, in weighted_assign_add
    return var.assign_add(math_ops.reduce_sum(label_and_pred, 1))
  File "/home/ye53nis/.conda/envs/mlflow-1114b06fb561908fc3f52e89d8342d7e52709c81/lib/python3.7/site-packages/tensorflow_core/python/ops/resource_variable_ops.py", line 785, in assign_add
    self.handle, ops.convert_to_tensor(delta, dtype=self.dtype),
  File "/home/ye53nis/.conda/envs/mlflow-1114b06fb561908fc3f52e89d8342d7e52709c81/lib/python3.7/site-packages/tensorflow_core/python/framework/ops.py", line 1290, in convert_to_tensor
    (dtype.name, value.dtype.name, value))
ValueError: Tensor conversion requested dtype float64 for Tensor with dtype float32: &lt;tf.Tensor 'metrics/precision/Sum:0' shape=(1,) dtype=float32&gt;
2020/05/05 15:16:13 ERROR mlflow.cli: === Run (ID '0fcf9dc61b3148d6b535b5e66a8a3db0') failed ===
[ye53nis@node007 drmed-git]$
</pre>

<p>
there is an issue with tf.metrics see <a href="https://github.com/tensorflow/tensorflow/issues/36790">here</a>. For now,
tf.keras.backend.set<sub>floatx</sub>('float64') doesn't work.
</p>

<p>
Next try: log the metrics manually and see if that works.
Or: Check first if the tensorboard metrics stored in <code>mlruns/artifacts</code> is maybe enough
</p>

<p>
I found a <a href="https://medium.com/@ij_82957/how-to-reduce-mlflow-logging-overhead-by-using-log-batch-b61301cc540f">nice article</a> dealing with how to log metrics from a history object.
For now I implement a approach based on <code>mlflow.log_metrics()</code>. There is a
faster approch using <code>mlflow.entities.Metric</code>, <code>mlflow.tracking.MlflowClient</code>
and <code>mlflow_client.log_batch()</code>. But I want to try the naive approach first.
</p>
</div>
</li>


<li><a id="sec-6-6-1-7" name="sec-6-6-1-7"></a>start and connect to jupyter<br ><div class="outline-text-5" id="text-6-6-1-7">
<div class="org-src-container">

<pre class="src src-tmux">srun -p gpu_test --time=1:00:00 --gres=gpu:2 --mem-per-cpu=1000 --ntasks-per-node=48 --pty bash
</pre>
</div>

<div class="org-src-container">

<pre class="src src-tmux">module load nvidia/cuda/10.1.168
module load nvidia/cudnn/7.5.1.10
conda activate tensorflow_nightly
<span style="color: #839496; font-weight: bold;">export</span> <span style="color: #268bd2;">PORT</span>=8889
<span style="color: #839496; font-weight: bold;">export</span> <span style="color: #268bd2;">XDG_RUNTIME_DIR</span>=<span style="color: #2aa198;">''</span>
<span style="color: #839496; font-weight: bold;">export</span> <span style="color: #268bd2;">XDG_RUNTIME_DIR</span>=<span style="color: #2aa198;">""</span>
<span style="color: #839496; font-weight: bold;">export</span> <span style="color: #268bd2;">LD_LIBRARY_PATH</span>=$<span style="color: #268bd2;">LD_LIBRARY_PATH</span>:/cluster/nvidia/cuda/10.1.168/extras/CUPTI/lib64
jupyter notebook --no-browser --port=$<span style="color: #268bd2;">PORT</span>
</pre>
</div>

<table class="table table-striped table-bordered table-hover table-condensed">


<colgroup>
<col  class="left">

<col  class="left">

<col  class="left">

<col  class="left">

<col  class="left">

<col  class="left">

<col  class="left">

<col  class="left">

<col  class="left">
</colgroup>
<tbody>
<tr>
<td class="text-left">sh-5.0$</td>
<td class="text-left">ye53nis@ara-login01.rz.uni-jena.de's</td>
<td class="text-left">password:</td>
<td class="text-left">&#xa0;</td>
<td class="text-left">&#xa0;</td>
<td class="text-left">&#xa0;</td>
<td class="text-left">&#xa0;</td>
<td class="text-left">&#xa0;</td>
<td class="text-left">&#xa0;</td>
</tr>

<tr>
<td class="text-left">ye53nis@node127's</td>
<td class="text-left">password:</td>
<td class="text-left">&#xa0;</td>
<td class="text-left">&#xa0;</td>
<td class="text-left">&#xa0;</td>
<td class="text-left">&#xa0;</td>
<td class="text-left">&#xa0;</td>
<td class="text-left">&#xa0;</td>
<td class="text-left">&#xa0;</td>
</tr>

<tr>
<td class="text-left">Last</td>
<td class="text-left">login:</td>
<td class="text-left">Wed</td>
<td class="text-left">May</td>
<td class="text-left">6</td>
<td class="text-left">23:16:52</td>
<td class="text-left">2020</td>
<td class="text-left">from</td>
<td class="text-left">login01.ara</td>
</tr>
</tbody>
</table>

<p>
I nstarted a Python3 kernel using <code>jupyter-server-list-kernels</code>. Then I added the
kernel ID to the <code>:PROPERTIES:</code> drawer of this (and following) subtrees.
</p>

<pre class="example">
python3          9e7e4701-35b1-4031-8f44-ed2586b82d49   2 minutes ago        starting   0
</pre>

<p>
Passing a boolean value to a variable in <code>org-babel</code> was not trivial: you have to
use the infamous <b>single quote '</b> from emacs-lisp programming to show that the
expression should be returned as written, not evaluated.
</p>

<pre class="example">
No of CPUs in system: 48
No of CPUs the current process can use: 48
load average: (0.07, 0.09, 0.76)
posix.uname_result(sysname='Linux', nodename='node127', release='3.10.0-957.1.3.el7.x86_64', version='#1 SMP Thu Nov 29 14:49:43 UTC 2018', machine='x86_64')
PID of process: 28280
RAM total: 137G, RAM used: 1.3G, RAM free: 15G
the current directory: /home/ye53nis
My disk usage:
Filesystem           Size  Used Avail Use% Mounted on
/dev/sda1             50G  5.7G   45G  12% /
devtmpfs              63G     0   63G   0% /dev
tmpfs                 63G   25M   63G   1% /dev/shm
tmpfs                 63G   59M   63G   1% /run
tmpfs                 63G     0   63G   0% /sys/fs/cgroup
nfs03-ib:/pool/work  100T   78T   23T  78% /nfsdata
nfs01-ib:/cluster    2.0T  316G  1.7T  16% /cluster
nfs01-ib:/home        80T   59T   22T  73% /home
/dev/sda5            2.0G   34M  2.0G   2% /tmp
/dev/sda6            169G  320M  169G   1% /local
/dev/sda3            6.0G  543M  5.5G   9% /var
beegfs_nodev         524T  427T   98T  82% /beegfs
tmpfs                 13G     0   13G   0% /run/user/67339
</pre>

<div class="org-src-container">

<pre class="src src-jupyter-python">%cd /beegfs/ye53nis/drmed-git
</pre>
</div>

<pre class="example">
/beegfs/ye53nis/drmed-git
</pre>


<div class="org-src-container">

<pre class="src src-jupyter-python"><span style="color: #859900; font-weight: bold;">import</span> sys
<span style="color: #859900; font-weight: bold;">import</span> matplotlib.pyplot <span style="color: #859900; font-weight: bold;">as</span> plt
<span style="color: #859900; font-weight: bold;">import</span> tensorflow <span style="color: #859900; font-weight: bold;">as</span> tf
sys.path.append(<span style="color: #2aa198;">'/beegfs/ye53nis/drmed-git/src/'</span>)
<span style="color: #859900; font-weight: bold;">from</span> fluotracify.simulations <span style="color: #859900; font-weight: bold;">import</span> import_simulation_from_csv <span style="color: #859900; font-weight: bold;">as</span> isfc
<span style="color: #859900; font-weight: bold;">from</span> fluotracify.training <span style="color: #859900; font-weight: bold;">import</span> build_model <span style="color: #859900; font-weight: bold;">as</span> bm, preprocess_data <span style="color: #859900; font-weight: bold;">as</span> ppd
tf.config.list_physical_devices(<span style="color: #2aa198;">'GPU'</span>)
</pre>
</div>

<pre class="example">
[]
</pre>


<div class="org-src-container">

<pre class="src src-jupyter-python"><span style="color: #839496; background-color: #002b36;">_batch_size</span> = <span style="color: #839496; background-color: #002b36;">5</span>
<span style="color: #839496; background-color: #002b36;">frac_val</span> = <span style="color: #839496; background-color: #002b36;">0</span>.<span style="color: #839496; background-color: #002b36;">2</span>
<span style="color: #839496; background-color: #002b36;">length_delimiter</span> = <span style="color: #839496; background-color: #002b36;">16384</span>
<span style="color: #839496; background-color: #002b36;">learning_rate</span> = 1e-<span style="color: #839496; background-color: #002b36;">5</span>
<span style="color: #839496; background-color: #002b36;">epochs</span> = <span style="color: #839496; background-color: #002b36;">10</span>
<span style="color: #839496; background-color: #002b36;">csv_path</span> = <span style="color: #2aa198;">'/beegfs/ye53nis/saves/firstartifact_Sep2019_subsample/'</span>
</pre>
</div>

<div class="org-src-container">

<pre class="src src-jupyter-python"><span style="color: #839496; background-color: #002b36;">train</span>, <span style="color: #839496; background-color: #002b36;">test</span>, <span style="color: #839496; background-color: #002b36;">nsamples</span>, <span style="color: #839496; background-color: #002b36;">experiment_params</span> = isfc.import_from_csv(
<span style="background-color: #073642;"> </span>   <span style="color: #839496; background-color: #002b36;">path</span>=csv_path,
<span style="background-color: #073642;"> </span>   <span style="color: #839496; background-color: #002b36;">header</span>=<span style="color: #839496; background-color: #002b36;">12</span>,
<span style="background-color: #073642;"> </span>   <span style="color: #839496; background-color: #002b36;">frac_train</span>=<span style="color: #839496; background-color: #002b36;">0</span>.<span style="color: #839496; background-color: #002b36;">8</span>,
<span style="background-color: #073642;"> </span>   <span style="color: #839496; background-color: #002b36;">col_per_example</span>=<span style="color: #839496; background-color: #002b36;">2</span>,
<span style="background-color: #073642;"> </span>   <span style="color: #839496; background-color: #002b36;">dropindex</span>=<span style="color: #859900; font-weight: bold;">None</span>,
<span style="background-color: #073642;"> </span>   <span style="color: #839496; background-color: #002b36;">dropcolumns</span>=<span style="color: #2aa198;">'Unnamed: 200'</span>)

<span style="color: #839496; background-color: #002b36;">train_data</span>, <span style="color: #839496; background-color: #002b36;">train_labels</span> = isfc.separate_data_and_labels(<span style="color: #839496; background-color: #002b36;">array</span>=train,
<span style="background-color: #073642;"> </span>   <span style="background-color: #073642;"> </span>   <span style="background-color: #073642;"> </span>   <span style="background-color: #073642;"> </span>   <span style="background-color: #073642;"> </span>   <span style="background-color: #073642;"> </span>   <span style="background-color: #073642;"> </span>   <span style="background-color: #073642;"> </span>   <span style="background-color: #073642;"> </span>   <span style="background-color: #073642;"> </span>   <span style="background-color: #073642;"> </span>   <span style="background-color: #073642;"> </span>   <span style="background-color: #073642;"> </span>   <span style="background-color: #073642;"> </span>   <span style="background-color: #073642;"> </span><span style="color: #839496; background-color: #002b36;">nsamples</span>=nsamples)
<span style="color: #839496; background-color: #002b36;">test_data</span>, <span style="color: #839496; background-color: #002b36;">test_labels</span> = isfc.separate_data_and_labels(<span style="color: #839496; background-color: #002b36;">array</span>=test,
<span style="background-color: #073642;"> </span>   <span style="background-color: #073642;"> </span>   <span style="background-color: #073642;"> </span>   <span style="background-color: #073642;"> </span>   <span style="background-color: #073642;"> </span>   <span style="background-color: #073642;"> </span>   <span style="background-color: #073642;"> </span>   <span style="background-color: #073642;"> </span>   <span style="background-color: #073642;"> </span>   <span style="background-color: #073642;"> </span>   <span style="background-color: #073642;"> </span>   <span style="background-color: #073642;"> </span>   <span style="background-color: #073642;"> </span>   <span style="background-color: #073642;"> </span>  <span style="color: #839496; background-color: #002b36;">nsamples</span>=nsamples)

<span style="color: #586e75;"># </span><span style="color: #586e75;">get bool as ground truth</span>
<span style="color: #839496; background-color: #002b36;">train_labels_bool</span> = train_labels &gt; <span style="color: #839496; background-color: #002b36;">0</span>.<span style="color: #839496; background-color: #002b36;">04</span>

<span style="color: #839496; background-color: #002b36;">test_labels_bool</span> = test_labels &gt; <span style="color: #839496; background-color: #002b36;">0</span>.<span style="color: #839496; background-color: #002b36;">04</span>
print(
<span style="background-color: #073642;"> </span>   <span style="color: #2aa198;">'\nfor each 20,000 timestap trace there are the following numbers '</span>
<span style="background-color: #073642;"> </span>   <span style="color: #2aa198;">'of corrupted timesteps:\n'</span>,
<span style="background-color: #073642;"> </span>   test_labels_bool.sum(<span style="color: #839496; background-color: #002b36;">axis</span>=<span style="color: #839496; background-color: #002b36;">0</span>).head())

<span style="color: #586e75;"># </span><span style="color: #586e75;">Cleanup</span>
<span style="color: #859900; font-weight: bold;">del</span> train, test
</pre>
</div>

<pre class="example">
train 0 /beegfs/ye53nis/saves/firstartifact_Sep2019_subsample/traces_cluster_rand_Sep2019_set003.csv
train 1 /beegfs/ye53nis/saves/firstartifact_Sep2019_subsample/traces_cluster_rand_Sep2019_set002.csv
test 2 /beegfs/ye53nis/saves/firstartifact_Sep2019_subsample/traces_cluster_rand_Sep2019_set001.csv
shapes of feature dataframe: (20000, 200) and label dataframe: (20000, 200)
shapes of feature dataframe: (20000, 100) and label dataframe: (20000, 100)

for each 20,000 timestap trace there are the following numbers of corrupted timesteps:
 label001_1     4124
label002_1     2261
label003_1       45
label004_1    13108
label005_1     2306
dtype: int64
</pre>

<div class="org-src-container">

<pre class="src src-jupyter-python"><span style="color: #839496; background-color: #002b36;">dataset_train</span>, <span style="color: #839496; background-color: #002b36;">dataset_val</span>, <span style="color: #839496; background-color: #002b36;">num_train_examples</span>, <span style="color: #839496; background-color: #002b36;">num_val_examples</span> = ppd.tfds_from_pddf_for_unet(
<span style="background-color: #073642;"> </span>   <span style="color: #839496; background-color: #002b36;">features_df</span>=train_data,
<span style="background-color: #073642;"> </span>   <span style="color: #839496; background-color: #002b36;">labels_df</span>=train_labels_bool,
<span style="background-color: #073642;"> </span>   <span style="color: #839496; background-color: #002b36;">is_training</span>=<span style="color: #859900; font-weight: bold;">True</span>,
<span style="background-color: #073642;"> </span>   <span style="color: #839496; background-color: #002b36;">batch_size</span>=_batch_size,
<span style="background-color: #073642;"> </span>   <span style="color: #839496; background-color: #002b36;">length_delimiter</span>=length_delimiter,
<span style="background-color: #073642;"> </span>   <span style="color: #839496; background-color: #002b36;">frac_val</span>=frac_val)

<span style="color: #839496; background-color: #002b36;">dataset_test</span>, <span style="color: #839496; background-color: #002b36;">num_test_examples</span> = ppd.tfds_from_pddf_for_unet(
<span style="background-color: #073642;"> </span>   <span style="color: #839496; background-color: #002b36;">features_df</span>=test_data,
<span style="background-color: #073642;"> </span>   <span style="color: #839496; background-color: #002b36;">labels_df</span>=test_labels_bool,
<span style="background-color: #073642;"> </span>   <span style="color: #839496; background-color: #002b36;">is_training</span>=<span style="color: #859900; font-weight: bold;">False</span>,
<span style="background-color: #073642;"> </span>   <span style="color: #839496; background-color: #002b36;">batch_size</span>=_batch_size,
<span style="background-color: #073642;"> </span>   <span style="color: #839496; background-color: #002b36;">length_delimiter</span>=length_delimiter)
</pre>
</div>

<pre class="example">
number of training examples: 160, number of validation examples: 40

------------------------
number of test examples: 100

</pre>


<div class="org-src-container">

<pre class="src src-jupyter-python"><span style="color: #839496; background-color: #002b36;">strategy</span> = tf.distribute.MirroredStrategy()
print(<span style="color: #2aa198;">'Number of devices: {}'</span>.format(strategy.num_replicas_in_sync))
</pre>
</div>

<pre class="example">
WARNING:tensorflow:There are non-GPU devices in `tf.distribute.Strategy`, not using nccl allreduce.
INFO:tensorflow:Using MirroredStrategy with devices ('/job:localhost/replica:0/task:0/device:CPU:0',)
Number of devices: 1
</pre>


<div class="org-src-container">

<pre class="src src-jupyter-python"><span style="color: #839496; background-color: #002b36;">model</span> = bm.unet_1d_alt(<span style="color: #839496; background-color: #002b36;">input_size</span>=length_delimiter)
<span style="color: #839496; background-color: #002b36;">optimizer</span> = tf.keras.optimizers.Adam(<span style="color: #839496; background-color: #002b36;">learning_rate</span>=learning_rate)
<span style="color: #839496; background-color: #002b36;">loss</span> = bm.binary_ce_dice_loss

model.compile(<span style="color: #839496; background-color: #002b36;">loss</span>=loss,
<span style="background-color: #073642;"> </span>   <span style="background-color: #073642;"> </span>   <span style="background-color: #073642;"> </span>   <span style="background-color: #073642;"> </span> <span style="color: #839496; background-color: #002b36;">optimizer</span>=optimizer,
<span style="background-color: #073642;"> </span>   <span style="background-color: #073642;"> </span>   <span style="background-color: #073642;"> </span>   <span style="background-color: #073642;"> </span> <span style="color: #839496; background-color: #002b36;">metrics</span>=[
<span style="background-color: #073642;"> </span>   <span style="background-color: #073642;"> </span>   <span style="background-color: #073642;"> </span>   <span style="background-color: #073642;"> </span>   <span style="background-color: #073642;"> </span> tf.keras.metrics.MeanIoU(<span style="color: #839496; background-color: #002b36;">num_classes</span>=<span style="color: #839496; background-color: #002b36;">2</span>),
<span style="background-color: #073642;"> </span>   <span style="background-color: #073642;"> </span>   <span style="background-color: #073642;"> </span>   <span style="background-color: #073642;"> </span>   <span style="background-color: #073642;"> </span> tf.keras.metrics.Precision(),
<span style="background-color: #073642;"> </span>   <span style="background-color: #073642;"> </span>   <span style="background-color: #073642;"> </span>   <span style="background-color: #073642;"> </span>   <span style="background-color: #073642;"> </span> tf.keras.metrics.Recall()
<span style="background-color: #073642;"> </span>   <span style="background-color: #073642;"> </span>   <span style="background-color: #073642;"> </span>   <span style="background-color: #073642;"> </span> ])

<span style="color: #839496; background-color: #002b36;">history</span> = model.fit(
<span style="background-color: #073642;"> </span>   <span style="color: #839496; background-color: #002b36;">x</span>=dataset_train,
<span style="background-color: #073642;"> </span>   <span style="color: #839496; background-color: #002b36;">epochs</span>=epochs,
<span style="background-color: #073642;"> </span>   <span style="color: #839496; background-color: #002b36;">steps_per_epoch</span>=tf.math.ceil(num_train_examples / _batch_size),
<span style="background-color: #073642;"> </span>   <span style="color: #839496; background-color: #002b36;">validation_data</span>=dataset_val,
<span style="background-color: #073642;"> </span>   <span style="color: #839496; background-color: #002b36;">validation_steps</span>=tf.math.ceil(num_val_examples / _batch_size))
</pre>
</div>

<pre class="example">
  input - shape:	 (None, 16384, 1)
  output - shape:	 (None, 16384, 1)
  Epoch 1/10
  32/32 [==============================] - 97s 3s/step - loss: 1.5873 - mean_io_u: 0.3986 - precision: 0.2489 - recall: 0.5378 - val_loss: 1.4996 - val_mean_io_u: 0.3783 - val_precision: 0.0000e+00 - val_recall: 0.0000e+00
  Epoch 2/10
  32/32 [==============================] - 93s 3s/step - loss: 1.5293 - mean_io_u: 0.4037 - precision: 0.3027 - recall: 0.6539 - val_loss: 1.4801 - val_mean_io_u: 0.3782 - val_precision: 0.0000e+00 - val_recall: 0.0000e+00
  Epoch 3/10
  32/32 [==============================] - 94s 3s/step - loss: 1.4660 - mean_io_u: 0.4071 - precision: 0.3465 - recall: 0.7087 - val_loss: 1.4734 - val_mean_io_u: 0.3934 - val_precision: 0.0000e+00 - val_recall: 0.0000e+00
  Epoch 4/10
32/32 [==============================] - 92s 3s/step - loss: 1.4164 - mean_io_u: 0.4035 - precision: 0.4074 - recall: 0.7071 - val_loss: 1.4653 - val_mean_io_u: 0.3894 - val_precision: 0.0000e+00 - val_recall: 0.0000e+00
  Epoch 5/10
32/32 [==============================] - 91s 3s/step - loss: 1.3456 - mean_io_u: 0.3991 - precision: 0.4956 - recall: 0.7108 - val_loss: 1.4867 - val_mean_io_u: 0.4216 - val_precision: 0.0000e+00 - val_recall: 0.0000e+00
  Epoch 6/10
32/32 [==============================] - 91s 3s/step - loss: 1.3310 - mean_io_u: 0.4111 - precision: 0.5083 - recall: 0.7445 - val_loss: 1.5757 - val_mean_io_u: 0.3901 - val_precision: 0.2414 - val_recall: 0.9313
  Epoch 7/10
32/32 [==============================] - 93s 3s/step - loss: 1.2963 - mean_io_u: 0.4076 - precision: 0.5743 - recall: 0.7135 - val_loss: 1.7852 - val_mean_io_u: 0.3509 - val_precision: 0.2983 - val_recall: 0.9997
  Epoch 8/10
32/32 [==============================] - 93s 3s/step - loss: 1.2417 - mean_io_u: 0.4025 - precision: 0.6651 - recall: 0.7382 - val_loss: 2.6641 - val_mean_io_u: 0.3951 - val_precision: 0.2097 - val_recall: 0.9998
  Epoch 9/10
32/32 [==============================] - 95s 3s/step - loss: 1.2306 - mean_io_u: 0.4079 - precision: 0.6707 - recall: 0.7559 - val_loss: 3.5447 - val_mean_io_u: 0.4057 - val_precision: 0.1887 - val_recall: 1.0000
  Epoch 10/10
32/32 [==============================] - 92s 3s/step - loss: 1.2321 - mean_io_u: 0.4104 - precision: 0.6717 - recall: 0.7411 - val_loss: 4.2015 - val_mean_io_u: 0.3820 - val_precision: 0.2359 - val_recall: 1.0000
</pre>

<p>
These GPU modules were missing:
libcublas.so.10 - I wrote to Sabine Irmer about that
libcudnn.so.7 - There was an extra <code>module load nvidia/cudnn/7.5.1.10</code> available
</p>

<div class="org-src-container">

<pre class="src src-jupyter-python">history.history
</pre>
</div>

<pre class="example">
{'loss': [1.5873368978500366,
  1.5292785167694092,
  1.4659773111343384,
  1.416449785232544,
  1.345642328262329,
  1.3310154676437378,
  1.2963486909866333,
  1.2417198419570923,
  1.2305928468704224,
  1.2321150302886963],
 'mean_io_u': [0.3985559344291687,
  0.4037455916404724,
  0.4071432948112488,
  0.40351858735084534,
  0.39908209443092346,
  0.41106948256492615,
  0.4076460599899292,
  0.40254250168800354,
  0.4079275131225586,
  0.41036319732666016],
 'precision': [0.2488986849784851,
  0.30270472168922424,
  0.34654930233955383,
  0.4073646366596222,
  0.49564093351364136,
  0.5083103179931641,
  0.5742575526237488,
  0.6650815606117249,
  0.6706622838973999,
  0.671720564365387],
 'recall': [0.537831723690033,
  0.6538828611373901,
  0.7087317705154419,
  0.7070884108543396,
  0.7108414173126221,
  0.7444652915000916,
  0.7134528160095215,
  0.7382367849349976,
  0.7559362649917603,
  0.741098940372467],
 'val_loss': [1.49961519241333,
  1.48013174533844,
  1.473410964012146,
  1.4653061628341675,
  1.4866881370544434,
  1.5756771564483643,
  1.785191297531128,
  2.664144515991211,
  3.5446887016296387,
  4.201501369476318],
 'val_mean_io_u': [0.3783065676689148,
  0.37820738554000854,
  0.3933570981025696,
  0.3894149661064148,
  0.42156678438186646,
  0.3901313841342926,
  0.3508506715297699,
  0.3951469361782074,
  0.4056693911552429,
  0.38204270601272583],
 'val_precision': [0.0,
  0.0,
  0.0,
  0.0,
  0.0,
  0.24144163727760315,
  0.2983255386352539,
  0.2097124308347702,
  0.18867774307727814,
  0.23592336475849152],
 'val_recall': [0.0,
  0.0,
  0.0,
  0.0,
  0.0,
  0.9312672019004822,
  0.9996521472930908,
  0.9997889995574951,
  0.9999595880508423,
  0.9999547004699707]}
</pre>

<div class="org-src-container">

<pre class="src src-jupyter-python">model.evaluate(dataset_test,
<span style="background-color: #073642;"> </span>   <span style="background-color: #073642;"> </span>   <span style="background-color: #073642;"> </span>   <span style="background-color: #073642;"> </span>  <span style="color: #839496; background-color: #002b36;">steps</span>=tf.math.ceil(num_test_examples / _batch_size))
</pre>
</div>

<pre class="example">
20/20 [==============================] - 10s 519ms/step - loss: 4.2488 - mean_io_u: 0.3849 - precision: 0.2301 - recall: 1.0000
[4.248773097991943,
 0.38494813442230225,
 0.23011629283428192,
 0.9999707937240601]
</pre>

<div class="org-src-container">

<pre class="src src-jupyter-python"><span style="color: #839496; background-color: #002b36;">it</span> = <span style="color: #839496; font-weight: bold;">iter</span>(dataset_test)

<span style="color: #839496; background-color: #002b36;">fig</span>, <span style="color: #839496; background-color: #002b36;">ax</span> = plt.subplots(<span style="color: #839496; background-color: #002b36;">5</span>, <span style="color: #839496; background-color: #002b36;">figsize</span>=(<span style="color: #839496; background-color: #002b36;">16</span>, <span style="color: #839496; background-color: #002b36;">12</span>))
<span style="color: #839496; background-color: #002b36;">count</span> = <span style="color: #839496; background-color: #002b36;">0</span>
<span style="color: #859900; font-weight: bold;">while</span> count &lt; <span style="color: #839496; background-color: #002b36;">5</span>:
<span style="background-color: #073642;"> </span>   <span style="color: #839496; background-color: #002b36;">example</span> = <span style="color: #839496; font-weight: bold;">next</span>(it)
<span style="background-color: #073642;"> </span>   ax[count].plot(example[<span style="color: #839496; background-color: #002b36;">0</span>][<span style="color: #839496; background-color: #002b36;">0</span>])
<span style="background-color: #073642;"> </span>   <span style="color: #839496; background-color: #002b36;">prediction</span> = model.predict(example[<span style="color: #839496; background-color: #002b36;">0</span>])
<span style="background-color: #073642;"> </span>   <span style="color: #839496; background-color: #002b36;">prediction</span> = prediction[<span style="color: #839496; background-color: #002b36;">0</span>] &gt; <span style="color: #839496; background-color: #002b36;">0</span>.<span style="color: #839496; background-color: #002b36;">5</span>
<span style="background-color: #073642;"> </span>   ax[count].plot(prediction*<span style="color: #839496; background-color: #002b36;">2</span>)
<span style="background-color: #073642;"> </span>   ax[count].plot(example[<span style="color: #839496; background-color: #002b36;">1</span>][<span style="color: #839496; background-color: #002b36;">0</span>])
<span style="background-color: #073642;"> </span>   <span style="color: #839496; background-color: #002b36;">count</span> += <span style="color: #839496; background-color: #002b36;">1</span>
</pre>
</div>

<pre class="example">
0c67d91d-f101-4868-b9a4-ed8cee57bee9
</pre>
</div>
</li></ol>
</div>
</div>

<div id="outline-container-sec-6-7" class="outline-3">
<h3 id="sec-6-7"><span class="section-number-3">6.7</span> Reading out mlflow logs</h3>
<div class="outline-text-3" id="text-6-7">
<div class="org-src-container">

<pre class="src src-tmux">conda activate tensorflow_env
<span style="color: #839496; font-weight: bold;">cd</span> Programme/drmed-git
<span style="color: #839496; font-weight: bold;">export</span> <span style="color: #268bd2;">MLFLOW_EXPERIMENT_NAME</span>=exp-devtest
<span style="color: #839496; font-weight: bold;">export</span> <span style="color: #268bd2;">MLFLOW_EXPERIMENT_ID</span>=0.1
<span style="color: #839496; font-weight: bold;">export</span> <span style="color: #268bd2;">MLFLOW_TRACKING_URI</span>=file:./data/mlruns
</pre>
</div>

<div class="org-src-container">

<pre class="src src-tmux">mlflow artifacts list -r cda4eec66a6947c38ec2ee2006563ae5
</pre>
</div>

<pre class="example">
[{
  "path": "model_summary.txt",
  "is_dir": false,
  "file_size": "10888"
}, {
  "path": "tensorboard_logs",
  "is_dir": true
}]
</pre>

<div class="org-src-container">

<pre class="src src-tmux">mlflow experiments list
</pre>
</div>

<pre class="example">
  Experiment Id  Name         Artifact Location
---------------  -----------  --------------------
              0  Default      file:./data/mlruns/0
              1  exp-devtest  file:./data/mlruns/1
</pre>

<div class="org-src-container">

<pre class="src src-tmux">mlflow runs describe --run-id cda4eec66a6947c38ec2ee2006563ae5
</pre>
</div>

<pre class="example">
{
    "info": {
        "artifact_uri": "file:./data/mlruns/1/cda4eec66a6947c38ec2ee2006563ae5/artifacts",
        "end_time": 1588424858258,
        "experiment_id": "1",
        "lifecycle_stage": "active",
        "run_id": "cda4eec66a6947c38ec2ee2006563ae5",
        "run_uuid": "cda4eec66a6947c38ec2ee2006563ae5",
        "start_time": 1588423619699,
        "status": "FINISHED",
        "user_id": "ye53nis"
    },
    "data": {
        "metrics": {},
        "params": {
            "opt_beta_1": "0.9",
            "validation_steps": "tf.Tensor(8.0, shape=(), dtype=float32)",
            "opt_learning_rate": "1e-05",
            "fluotracify_path": "/beegfs/ye53nis/drmed-git/src/",
            "opt_amsgrad": "False",
            "frac_val": "0.2",
            "batch_size": "5",
            "epochs": "10",
            "opt_decay": "0.0",
            "steps_per_epoch": "tf.Tensor(32.0, shape=(), dtype=float32)",
            "length_delimiter": "16384",
            "opt_name": "Adam",
            "opt_beta_2": "0.999",
            "csv_path": "/beegfs/ye53nis/saves/firstartifact_Sep2019_subsample/",
            "learning_rate": "1e-5",
            "opt_epsilon": "1e-07"
        },
        "tags": {
            "mlflow.source.git.repoURL": "https://github.com/aseltmann/fluotracify",
            "mlflow.source.type": "PROJECT",
            "mlflow.source.name": "file:///beegfs/ye53nis/drmed-git",
            "mlflow.user": "ye53nis",
            "mlflow.source.git.commit": "9e6182fbeae831a151342827efa59581e4310ae6",
            "mlflow.gitRepoURL": "https://github.com/aseltmann/fluotracify",
            "mlflow.project.backend": "local",
            "mlflow.project.env": "conda",
            "mlflow.project.entryPoint": "main"
        }
    }
}

</pre>

<div class="org-src-container">

<pre class="src src-tmux">tensorboard --logdir=data/mlruns/1/cda4eec66a6947c38ec2ee2006563ae5/artifacts/tensorboard_logs
</pre>
</div>

<pre class="example">
Serving TensorBoard on localhost; to expose to the network, use a proxy or pass --bind_all
TensorBoard 2.0.0 at http://localhost:6006/ (Press CTRL+C to quit)
</pre>
</div>
</div>



<div id="outline-container-sec-6-8" class="outline-3">
<h3 id="sec-6-8"><span class="section-number-3">6.8</span> TODOs</h3>
<div class="outline-text-3" id="text-6-8">
</div><ol class="org-ol"><li><a id="sec-6-8-0-1" name="sec-6-8-0-1"></a><span class="label label-primary TODO">TODO</span> Investigate Error on GPU node<br ><div class="outline-text-5" id="text-6-8-0-1">
<ul class="org-ul">
<li>2020-04-13 02:45:28.216446: W
tensorflow/stream<sub>executor</sub>/platform/default/dso<sub>loader.cc</sub>:55] Could not load
dynamic library 'libnvinfer.so.6'; dlerror: libnvinfer.so.6: cannot open
shared object file: No such file or directory; LD<sub>LIBRARY</sub><sub>PATH</sub>:
/cluster/miniconda3/lib
</li>
<li>2020-04-13 02:45:28.217069: W
tensorflow/stream<sub>executor</sub>/platform/default/dso<sub>loader.cc</sub>:55] Could not load
dynamic library 'libnvinfer<sub>plugin.so.6</sub>'; dlerror: libnvinfer<sub>plugin.so.6</sub>:
cannot open shared object file: No such file or directory; LD<sub>LIBRARY</sub><sub>PATH</sub>:
/cluster/miniconda3/lib
</li>
<li>2020-04-13 02:45:28.217123: W
tensorflow/compiler/tf2tensorrt/utils/py<sub>utils.cc</sub>:30] Cannot dlopen some
TensorRT libraries. If you would like to use Nvidia GPU with TensorRT, please
make sure the missing libraries mentioned above are installed properly
</li>
</ul>
</div>
</li>
<li><a id="sec-6-8-0-2" name="sec-6-8-0-2"></a><span class="label label-primary TODO">TODO</span> Export pandas DataFrames as org tables instead of html<br ><div class="outline-text-5" id="text-6-8-0-2">
<ul class="org-ul">
<li>see <a href="https://github.com/dzop/emacs-jupyter/issues/88">https://github.com/dzop/emacs-jupyter/issues/88</a>
</li>
<li>see
<a href="https://github.com/gregsexton/ob-ipython/blob/7147455230841744fb5b95dcbe03320313a77124/README.org#tips-and-tricks">https://github.com/gregsexton/ob-ipython/blob/7147455230841744fb5b95dcbe03320313a77124/README.org#tips-and-tricks</a>
</li>
</ul>
</div>
</li>
<li><a id="sec-6-8-0-3" name="sec-6-8-0-3"></a><span class="label label-primary TODO">TODO</span> Inline-display of plots<br ></li>
<li><a id="sec-6-8-0-4" name="sec-6-8-0-4"></a><span class="label label-primary TODO">TODO</span> fix pydot and graphviz to make model plotting work<br ></li>
<li><a id="sec-6-8-0-5" name="sec-6-8-0-5"></a><span class="label label-primary TODO">TODO</span> transform ML training ipynb to py files as used <a href="https://github.com/mlflow/mlflow/blob/master/examples/tensorflow/tf2/train_predict_2.py">here</a><br ></li>
<li><a id="sec-6-8-0-6" name="sec-6-8-0-6"></a><span class="label label-primary TODO">TODO</span> check out python module <code>argparser</code> as used <a href="https://github.com/mlflow/mlflow/blob/master/examples/tensorflow/tf2/train_predict_2.py">here</a><br ></li></ol>
<div id="outline-container-sec-6-8-1" class="outline-4">
<h4 id="sec-6-8-1"><span class="section-number-4">6.8.1</span> <span class="label label-primary TODO">TODO</span> Further setup of git branching model</h4>
</div>
<div id="outline-container-sec-6-8-2" class="outline-4">
<h4 id="sec-6-8-2"><span class="section-number-4">6.8.2</span> <span class="label label-primary PENDING">PENDING</span> Fix isort and sys.path conflicts</h4>
<div class="outline-text-4" id="text-6-8-2">
<ul class="org-ul">
<li>State "PENDING"    from "TODO"       <span class="timestamp-wrapper"><span class="timestamp">[2020-05-02 Sa 13:06] </span></span> <br >
Waiting for isort 5.0.0 release
</li>
</ul>
<p>
See here: <a href="https://github.com/timothycrosley/isort/issues/468#issuecomment-570899233">https://github.com/timothycrosley/isort/issues/468#issuecomment-570899233</a>
</p>
</div>
</div>
<div id="outline-container-sec-6-8-3" class="outline-4">
<h4 id="sec-6-8-3"><span class="section-number-4">6.8.3</span> <span class="label label-primary TODO">TODO</span> Implement talos 1.0 with mlflow, see <a href="file:///home/lex/Dokumente/org/04_Digital-und-Technik/programmieren.html#MissingReference">here</a></h4>
</div>
<div id="outline-container-sec-6-8-4" class="outline-4">
<h4 id="sec-6-8-4"><span class="section-number-4">6.8.4</span> <span class="label label-primary TODO">TODO</span> Set up nice package using cookiecutter, poetry, See <a href="https://stackoverflow.com/questions/49474575/how-to-install-my-own-python-module-package-via-conda-and-watch-its-changes">here</a></h4>
</div>
</div>
</div>
<div id="outline-container-sec-7" class="outline-2">
<h2 id="sec-7"><span class="section-number-2">7</span> Reconnect</h2>
<div class="outline-text-2" id="text-7">
</div>
<div id="outline-container-sec-7-1" class="outline-3">
<h3 id="sec-7-1"><span class="section-number-3">7.1</span> Tmux on Ara</h3>
<div class="outline-text-3" id="text-7-1">
<table class="table table-striped table-bordered table-hover table-condensed">


<colgroup>
<col  class="left">

<col  class="left">

<col  class="left">
</colgroup>
<tbody>
<tr>
<td class="text-left">ye53nis@ara-login01.rz.uni-jena.de's</td>
<td class="text-left">password:</td>
<td class="text-left">&#xa0;</td>
</tr>

<tr>
<td class="text-left">/tmp/tmux-67339/default</td>
<td class="text-left">&#xa0;</td>
<td class="text-left">&#xa0;</td>
</tr>

<tr>
<td class="text-left">&gt;</td>
<td class="text-left">ye53nis@ara-login01.rz.uni-jena.de's</td>
<td class="text-left">password:</td>
</tr>
</tbody>
</table>

<p>
Test:
</p>

<div class="org-src-container">

<pre class="src src-tmux"><span style="color: #839496; font-weight: bold;">pwd</span>
</pre>
</div>

<pre class="example">

</pre>
</div>
</div>

<div id="outline-container-sec-7-2" class="outline-3">
<h3 id="sec-7-2"><span class="section-number-3">7.2</span> Jupyter on Ara</h3>
<div class="outline-text-3" id="text-7-2">
<table class="table table-striped table-bordered table-hover table-condensed">


<colgroup>
<col  class="left">

<col  class="left">

<col  class="left">

<col  class="left">

<col  class="left">

<col  class="left">

<col  class="left">

<col  class="left">

<col  class="left">
</colgroup>
<tbody>
<tr>
<td class="text-left">sh-5.0$</td>
<td class="text-left">ye53nis@ara-login01.rz.uni-jena.de's</td>
<td class="text-left">password:</td>
<td class="text-left">&#xa0;</td>
<td class="text-left">&#xa0;</td>
<td class="text-left">&#xa0;</td>
<td class="text-left">&#xa0;</td>
<td class="text-left">&#xa0;</td>
<td class="text-left">&#xa0;</td>
</tr>

<tr>
<td class="text-left">ye53nis@node018's</td>
<td class="text-left">password:</td>
<td class="text-left">&#xa0;</td>
<td class="text-left">&#xa0;</td>
<td class="text-left">&#xa0;</td>
<td class="text-left">&#xa0;</td>
<td class="text-left">&#xa0;</td>
<td class="text-left">&#xa0;</td>
<td class="text-left">&#xa0;</td>
</tr>

<tr>
<td class="text-left">Last</td>
<td class="text-left">login:</td>
<td class="text-left">Sat</td>
<td class="text-left">Apr</td>
<td class="text-left">25</td>
<td class="text-left">13:40:36</td>
<td class="text-left">2020</td>
<td class="text-left">from</td>
<td class="text-left">login01.ara</td>
</tr>
</tbody>
</table>

<p>
Test:
</p>
</div>
</div>
</div>
</div><div class="col-md-3"><nav id="table-of-contents">
<div id="text-table-of-contents" class="bs-docs-sidebar">
<ul class="nav">
<li><a href="#sec-1">1. README</a>
<ul class="nav">
<li><a href="#sec-1-1">1.1. General:</a></li>
<li><a href="#sec-1-2">1.2. Experiments workflow:</a></li>
<li><a href="#sec-1-3">1.3. Example for experimental setup procedure</a>
<ul class="nav">
<li><a href="#sec-tmux-setup">1.3.1. Setting up a tmux connection from using <code>ob-tmux</code> in <code>org-babel</code></a></li>
<li><a href="#sec-jupyter-setup">1.3.2. Setting starting a jupyter kernel from a remote jupyter session using <code>emacs-jupyter</code> in <code>org babel</code></a></li>
</ul>
</li>
<li><a href="#sec-1-4">1.4. tools used (notes)</a>
<ul class="nav">
<li><a href="#sec-1-4-1">1.4.1. Emacs <code>magit</code></a></li>
<li><a href="#sec-1-4-2">1.4.2. jupyter</a></li>
<li><a href="#sec-1-4-3">1.4.3. mlflow</a></li>
<li><a href="#sec-1-4-4">1.4.4. tensorflow</a></li>
</ul>
</li>
<li><a href="#sec-1-5">1.5. Example for &#x2026;</a></li>
</ul>
</li>
<li><a href="#sec-2">2. Template for data entry:</a>
<ul class="nav">
<li><a href="#sec-2-1">2.1. exp-#date-#title</a>
<ul class="nav">
<li><a href="#sec-2-1-1">2.1.1. git:</a></li>
<li><a href="#sec-2-1-2">2.1.2. System Metadata:</a></li>
<li><a href="#scripts-tmux">2.1.3. Tmux setup and scripts</a></li>
<li><a href="#sec-2-1-4">2.1.4. jupyter setup and ssh tunneling</a></li>
<li><a href="#sec-2-1-5">2.1.5. Notes:</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#sec-3">3. Organization of git</a>
<ul class="nav">
<li><a href="#sec-3-1">3.1. remote/origin/master branch:</a></li>
<li><a href="#sec-3-2">3.2. remote/origin/exp### branches:</a></li>
<li><a href="#sec-3-3">3.3. remote/origin/develop branch:</a></li>
<li><a href="#sec-3-4">3.4. remote/origin/data branch:</a></li>
<li><a href="#sec-3-5">3.5. Git TAGs</a>
<ul class="nav">
<li><a href="#sec-3-5-1">3.5.1. Stable versions:</a></li>
<li><a href="#sec-3-5-2">3.5.2. All tags from git:</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#sec-4">4. Organization of code</a>
<ul class="nav">
<li><a href="#sec-4-1">4.1. scripts:</a></li>
<li><a href="#sec-4-2">4.2. src/</a>
<ul class="nav">
<li><a href="#sec-4-2-1">4.2.1. fluotracify/</a></li>
<li><a href="#sec-4-2-2">4.2.2. nanosimpy/</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#sec-5">5. Changes in this repository (without "* Data" in this file)</a>
<ul class="nav">
<li><a href="#sec-5-1">5.1. Changes in LabBook.org (without "* Data")</a>
<ul class="nav">
<li><a href="#sec-5-1-1">5.1.1. 2020-04-22</a></li>
<li><a href="#sec-5-1-2">5.1.2. 2020-03-30</a></li>
</ul>
</li>
<li><a href="#sec-5-2">5.2. Changes in src/fluotracify</a></li>
</ul>
</li>
<li><a href="#sec-6">6. DEVELOPMENT TESTING (don't merge in master)</a>
<ul class="nav">
<li><a href="#sec-6-1">6.1. configured custom yasnippets,</a></li>
<li><a href="#sec-6-2">6.2. fix hardlinks of org-files outside <code>Dokumente/org</code></a></li>
<li><a href="#sec-6-3">6.3. connect LabBook to HPC with jupyter etc</a>
<ul class="nav">
<li><a href="#sec-6-3-1">6.3.1. connect to compute node</a></li>
<li><a href="#sec-6-3-2">6.3.2. start and connect to jupyter</a></li>
</ul>
</li>
<li><a href="#sec-6-4">6.4. set up mlflow</a>
<ul class="nav">
<li><a href="#sec-6-4-1">6.4.1. how do I submit mlflow jobs?</a></li>
<li><a href="#sec-6-4-2">6.4.2. Reading the docs: mlflow</a></li>
<li><a href="#sec-6-4-3">6.4.3. Reading Barredo Arrieta et al: Explainable Artificial Intelligence (XIA)</a></li>
<li><a href="#sec-6-4-4">6.4.4. Set up git on HPC</a></li>
<li><a href="#sec-6-4-5">6.4.5. run mlflow test</a></li>
</ul>
</li>
<li><a href="#sec-6-5">6.5. Find solution for large file problem</a>
<ul class="nav">
<li><a href="#sec-6-5-1">6.5.1. using <code>git-lfs</code></a></li>
</ul>
</li>
<li><a href="#sec-6-6">6.6. run mlflow model as above, but save everything on <code>/beegfs</code></a>
<ul class="nav">
<li><a href="#sec-6-6-1">6.6.1. checking out mlflow error messages <code>[0/5]</code></a></li>
</ul>
</li>
<li><a href="#sec-6-7">6.7. Reading out mlflow logs</a></li>
<li><a href="#sec-6-8">6.8. TODOs</a>
<ul class="nav">
<li><a href="#sec-6-8-1">6.8.1. Further setup of git branching model</a></li>
<li><a href="#sec-6-8-2">6.8.2. Fix isort and sys.path conflicts</a></li>
<li><a href="#sec-6-8-3">6.8.3. Implement talos 1.0 with mlflow, see here</a></li>
<li><a href="#sec-6-8-4">6.8.4. Set up nice package using cookiecutter, poetry, See here</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#sec-7">7. Reconnect</a>
<ul class="nav">
<li><a href="#sec-7-1">7.1. Tmux on Ara</a></li>
<li><a href="#sec-7-2">7.2. Jupyter on Ara</a></li>
</ul>
</li>
</ul>
</div>
</nav>
</div></div></div>
<footer id="postamble" class="">
<div><p class="author">Author: Alexander Seltmann</p>
<p class="date">Created: 2020-05-07 Do 18:20</p>
<p class="creator"><a href="http://www.gnu.org/software/emacs/">Emacs</a> 26.3 (<a href="http://orgmode.org">Org-mode</a> 9.3.6)</p>
</div>
</footer>
</body>
</html>
